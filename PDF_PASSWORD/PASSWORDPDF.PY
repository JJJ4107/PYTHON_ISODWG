import os
from tkinter import Tk, filedialog, simpledialog, messagebox
from PyPDF2 import PdfReader, PdfWriter, PdfMerger

def unlock_pdf_to_memory(path, password):
    try:
        reader = PdfReader(path)
        if reader.is_encrypted:
            reader.decrypt(password)
        writer = PdfWriter()
        for page in reader.pages:
            writer.add_page(page)
        from io import BytesIO
        mem_file = BytesIO()
        writer.write(mem_file)
        mem_file.seek(0)
        return mem_file
    except Exception as e:
        print(f"âŒ {os.path.basename(path)} ì˜¤ë¥˜: {e}")
        return None

def main():
    root = Tk()
    root.withdraw()

    # 1. í´ë” ì„ íƒ
    folder = filedialog.askdirectory(title="ğŸ“‚ PDFê°€ ìˆëŠ” í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”")
    if not folder:
        print("â— í´ë” ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        return

    # 2. ì•”í˜¸ ì…ë ¥
    password = simpledialog.askstring("ğŸ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "PDF íŒŒì¼ì˜ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", show="*")
    if not password:
        print("â— ì•”í˜¸ ì…ë ¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        return

    # 3. PDF íŒŒì¼ ëª©ë¡
    pdf_files = [f for f in os.listdir(folder) if f.lower().endswith(".pdf")]
    if not pdf_files:
        messagebox.showinfo("â— ì—†ìŒ", "ì„ íƒí•œ í´ë”ì— PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 4. ë³‘í•© ì¤€ë¹„
    merger = PdfMerger()
    count = 0
    for pdf in pdf_files:
        full_path = os.path.join(folder, pdf)
        mem_file = unlock_pdf_to_memory(full_path, password)
        if mem_file:
            merger.append(mem_file)
            count += 1

    if count == 0:
        messagebox.showerror("ì‹¤íŒ¨", "ì•”í˜¸ í•´ì œì— ì„±ê³µí•œ PDFê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 5. ìµœì¢… íŒŒì¼ëª… ì…ë ¥
    output_name = simpledialog.askstring("ğŸ“„ ì €ì¥í•  ì´ë¦„", "ìµœì¢… ë³‘í•©ëœ PDF íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸):")
    if not output_name:
        messagebox.showinfo("ì·¨ì†Œ", "íŒŒì¼ ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        return

    output_path = os.path.join(folder, f"{output_name}.pdf")
    merger.write(output_path)
    merger.close()

    messagebox.showinfo("âœ… ì™„ë£Œ", f"{count}ê°œì˜ PDFë¥¼ ë³‘í•©í•˜ì—¬ ì €ì¥í–ˆìŠµë‹ˆë‹¤:\n\n{output_path}")

if __name__ == "__main__":
    main()
