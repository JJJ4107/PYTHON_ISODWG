import clr
import csv
import sys
import os
import tkinter as tk
from tkinter import filedialog

# --------- [1] Autodesk API ê²½ë¡œ ì¶”ê°€ ---------
api_path = r"C:\Program Files\Autodesk\Navisworks Manage 2024\api"
sys.path.append(api_path)

# --------- [2] .NET ì–´ì…ˆë¸”ë¦¬ ì°¸ì¡° ---------
try:
    clr.AddReference("Autodesk.Navisworks.Api")
    clr.AddReference("Autodesk.Navisworks.Timeliner")
    clr.AddReference("Autodesk.Navisworks.Api.Interop.ComApi")
except Exception as e:
    print("âŒ DLL ë¡œë”© ì‹¤íŒ¨: Autodesk API DLLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    print("ğŸ“Œ DLL ê²½ë¡œ í™•ì¸: ", api_path)
    print("ğŸ”§ ì˜ˆì™¸ ë©”ì‹œì§€:", e)
    sys.exit(1)

# --------- [3] ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ---------
from Autodesk.Navisworks.Api import *
from Autodesk.Navisworks.Api.DocumentParts import *
from Autodesk.Navisworks.Api.Interop.ComApi import InwOpState10, ComApiBridge

# --------- [4] íŒŒì¼ ì„ íƒ í•¨ìˆ˜ ---------
def select_file(title, filetypes):
    root = tk.Tk()
    root.withdraw()
    return filedialog.askopenfilename(title=title, filetypes=filetypes)

# --------- [5] CSVì—ì„œ ì´ë¦„ ëª©ë¡ ì½ê¸° ---------
def read_csv_item_names(csv_path):
    with open(csv_path, 'r', encoding='utf-8-sig') as f:
        reader = csv.DictReader(f)
        return [row['Name'].strip() for row in reader]

# --------- [6] ìƒ‰ìƒ ë®ì–´ì“°ê¸° í•¨ìˆ˜ ---------
def override_color(doc, model_item, color):
    overrides = doc.Models.OverrideAppearance
    appearance = overrides.GetAppearanceOverride(model_item) or Appearance()
    appearance.Color = color
    overrides.SetAppearanceOverride(model_item, appearance)

# --------- [7] ëª¨ë¸ ì „ì²´ í•­ëª© íƒìƒ‰ ---------
def search_all_items(models):
    def recurse(item):
        result = []
        for child in item.Children:
            result.extend(recurse(child))
        result.append(item)
        return result

    all_items = []
    for model in models:
        all_items.extend(recurse(model.RootItem))
    return all_items

# --------- [8] ë©”ì¸ ì‹¤í–‰ ---------
def main():
    print("ğŸ“‚ Navisworks NWD íŒŒì¼ê³¼ CSVë¥¼ ì„ íƒí•˜ì„¸ìš”.")
    nwd_path = select_file("NWD íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", [("Navisworks files", "*.nwd")])
    if not nwd_path:
        print("âš ï¸ NWD íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    csv_path = select_file("CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", [("CSV files", "*.csv")])
    if not csv_path:
        print("âš ï¸ CSV íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    item_names = read_csv_item_names(csv_path)
    print(f"âœ… CSVì—ì„œ {len(item_names)}ê°œì˜ í•­ëª©ì„ ì½ìŒ.")

    # -------- Navisworks API ì‹¤í–‰ --------
    print("ğŸ§© Navisworks íŒŒì¼ ì—´ê¸° ì¤‘...")
    state = ComApiBridge.State
    state10 = clr.Convert(state, InwOpState10)
    state10.OpenFile(nwd_path)

    doc = Application.ActiveDocument
    if doc is None:
        print("âŒ Navisworks ë¬¸ì„œë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Navisworksê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.")
        return

    all_items = search_all_items(doc.Models)
    matched_count = 0

    for item in all_items:
        name = item.DisplayName.strip()
        if name in item_names:
            override_color(doc, item, Color.Red)
            matched_count += 1

    print(f"ğŸ¨ {matched_count}ê°œì˜ í•­ëª©ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì„¤ì • ì™„ë£Œ.")

if __name__ == "__main__":
    main()
