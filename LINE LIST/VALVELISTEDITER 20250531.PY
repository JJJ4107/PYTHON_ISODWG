import csv
import fitz
import os
import subprocess
import time
import shutil

# íŒŒì¼ ê²½ë¡œ ì„¤ì •
csv_file = 'VALVELIST.CSV'
original_pdf_file = 'PID.PDF'
output_folder = 'PDF_OUTPUT'
temp_copied_pdf = 'TEMP_WORKING.PDF'
sumatra_path = r"C:\Users\acepl\AppData\Local\SumatraPDF\SumatraPDF.exe"

# ì¶œë ¥ í´ë” ì¤€ë¹„
if not os.path.exists(output_folder):
    os.makedirs(output_folder)

# íŒŒì¼ í™•ì¸
if not os.path.exists(csv_file) or not os.path.exists(original_pdf_file):
    print("CSV ë˜ëŠ” PDF íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    exit()

if not os.path.exists(sumatra_path):
    print("SumatraPDF ì‹¤í–‰ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    exit()

# ë§¤ ê²€ìƒ‰ë§ˆë‹¤ TEMP ë³µì‚¬ë³¸ ì‚¬ìš© (ì›ë³¸ ë³´í˜¸)
shutil.copyfile(original_pdf_file, temp_copied_pdf)

# Crop ì˜ì—­ ì„¤ì •
crop_width = 1000
crop_height = 800

with open(csv_file, 'r', newline='', encoding='utf-8-sig') as file:
    reader = csv.reader(file)
    count = 1

    for row in reader:
        if not row:
            continue

        vname = row[0].strip()
        if not vname:
            continue

        print(f"\n[{count}] VNAME ê²€ìƒ‰: {vname}")

        src_doc = fitz.open(temp_copied_pdf)
        found = False

        for i in range(src_doc.page_count):
            page = src_doc.load_page(i)
            text_instances = page.search_for(vname)
            if text_instances:
                found = True

                first_rect = text_instances[0]

                center_x = (first_rect.x0 + first_rect.x1) / 2
                center_y = (first_rect.y0 + first_rect.y1) / 2

                crop_rect = fitz.Rect(
                    center_x - crop_width/2,
                    center_y - crop_height/2,
                    center_x + crop_width/2,
                    center_y + crop_height/2
                )

                # ì›ë³¸ í˜ì´ì§€ì—ì„œ í•´ë‹¹ í˜ì´ì§€ë§Œ ì¶”ì¶œ
                page_pdf = fitz.open()
                page_pdf.insert_pdf(src_doc, from_page=i, to_page=i)
                src_doc.close()

                # ìƒˆ crop PDF ìƒì„±
                new_doc = fitz.open()
                new_page = new_doc.new_page(width=crop_width, height=crop_height)
                new_page.show_pdf_page(new_page.rect, page_pdf, 0, clip=crop_rect)

                # ì¢Œí‘œ ë³´ì •: offset + scale ì ìš© (ì™„ì „ ì •ë°€ ë³´ì •)
                scale_x = crop_width / crop_rect.width
                scale_y = crop_height / crop_rect.height
                offset_x = crop_rect.x0
                offset_y = crop_rect.y0

                adjusted_rect = fitz.Rect(
                    (first_rect.x0 - offset_x) * scale_x,
                    (first_rect.y0 - offset_y) * scale_y,
                    (first_rect.x1 - offset_x) * scale_x,
                    (first_rect.y1 - offset_y) * scale_y
                )

                highlight = new_page.add_highlight_annot(adjusted_rect)
                highlight.update()

                # ìƒˆ PDF ì €ì¥
                output_pdf = os.path.join(output_folder, f"VNAME_{count}.pdf")
                new_doc.save(output_pdf)
                new_doc.close()
                page_pdf.close()

                break

        else:
            src_doc.close()

        if not found:
            print("  - ê²€ìƒ‰ê²°ê³¼ ì—†ìŒ.")
            input("ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...")
            count += 1
            continue

        # SumatraPDFì— í•´ë‹¹ cropëœ ìƒˆ PDFë¥¼ ì˜¤í”ˆ
        subprocess.Popen([
            sumatra_path,
            "-reuse-instance",
            os.path.abspath(output_pdf)
        ], shell=False)

        time.sleep(1)
        input("ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê²€ìƒ‰ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...")
        count += 1

print("\nğŸ¯ ëª¨ë“  ê²€ìƒ‰ ë° í•˜ì´ë¼ì´íŠ¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
