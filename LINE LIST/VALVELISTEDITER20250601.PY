import csv
import fitz  # PyMuPDF
import os
import subprocess
import shutil

# === ì„¤ì • ===
csv_file = 'VALVELIST.CSV'
original_pdf_file = 'PID.PDF'
temp_copied_pdf = 'TEMP_WORKING.PDF'
sumatra_path = r"C:\Users\acepl\AppData\Local\SumatraPDF\SumatraPDF.exe"
log_file = 'search_log.txt'
temp_current_pdf = 'CURRENT_OUTPUT.PDF'

# === Crop ì˜ì—­ ì„¤ì • ===
crop_width = 450
crop_height = 400

# === íŒŒì¼ ì¡´ì¬ í™•ì¸ ===
for file in [csv_file, original_pdf_file, sumatra_path]:
    if not os.path.exists(file):
        print(f"í•„ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {file}")
        exit()

# ì›ë³¸ PDF ë³µì‚¬ (ì›ë³¸ ë³´í˜¸)
shutil.copyfile(original_pdf_file, temp_copied_pdf)

# ë¡œê·¸ ì´ˆê¸°í™”
with open(log_file, 'w', encoding='utf-8') as log:
    log.write("ê²€ìƒ‰ê²°ê³¼ ë¡œê·¸\n\n")

# CSV íŒŒì¼ ì½ê¸°
with open(csv_file, 'r', newline='', encoding='utf-8-sig') as file:
    reader = csv.reader(file)
    count = 1

    for row in reader:
        if not row or not row[0].strip():
            continue

        vname = row[0].strip()
        print(f"\n[{count}] VNAME ê²€ìƒ‰: {vname}")

        try:
            src_doc = fitz.open(temp_copied_pdf)
        except Exception as e:
            print(f"PDF ì—´ê¸° ì‹¤íŒ¨: {e}")
            continue

        found = False

        for i, page in enumerate(src_doc):
            text_instances = page.search_for(vname)
            if text_instances:
                found = True
                first_rect = text_instances[0]
                center_x = (first_rect.x0 + first_rect.x1) / 2
                center_y = (first_rect.y0 + first_rect.y1) / 2

                crop_rect = fitz.Rect(
                    center_x - crop_width / 2,
                    center_y - crop_height / 2,
                    center_x + crop_width / 2,
                    center_y + crop_height / 2
                )

                # í˜ì´ì§€ ì¶”ì¶œ ë° í¬ë¡­
                page_pdf = fitz.open()
                page_pdf.insert_pdf(src_doc, from_page=i, to_page=i)

                new_doc = fitz.open()
                new_page = new_doc.new_page(width=crop_width, height=crop_height)
                new_page.show_pdf_page(new_page.rect, page_pdf, 0, clip=crop_rect)

                # í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜ ë³´ì •
                offset_x, offset_y = crop_rect.x0, crop_rect.y0

                adjusted_rect = fitz.Rect(
                    (first_rect.x0 - offset_x),
                    (first_rect.y0 - offset_y),
                    (first_rect.x1 - offset_x),
                    (first_rect.y1 - offset_y)
                )

                highlight = new_page.add_highlight_annot(adjusted_rect)
                highlight.update()

                new_doc.save(temp_current_pdf)
                new_doc.close()
                page_pdf.close()
                break

        src_doc.close()

        with open(log_file, 'a', encoding='utf-8') as log:
            if found:
                log.write(f"[{count}] {vname} â†’ FOUND\n")
            else:
                log.write(f"[{count}] {vname} â†’ NOT FOUND\n")

        # SumatraPDFë¡œ ë³´ì—¬ì£¼ê¸° (2ë°° í™•ëŒ€ ì ìš©)
        if found:
            subprocess.Popen([
                sumatra_path, "-reuse-instance", "-zoom", "200", os.path.abspath(temp_current_pdf)
            ], shell=False)

        input("â†’ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê²€ìƒ‰ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...")
        count += 1

# ì„ì‹œíŒŒì¼ ì •ë¦¬
for temp_file in [temp_copied_pdf, temp_current_pdf]:
    try:
        os.remove(temp_file)
    except:
        pass

print("\nğŸ¯ ëª¨ë“  ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ ì¢…ë£Œ.")
