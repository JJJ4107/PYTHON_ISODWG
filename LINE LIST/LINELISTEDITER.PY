import csv
import fitz  # PyMuPDF
import os
import subprocess
import shutil

# === ì„¤ì • ===
csv_file = 'LINELIST.CSV'
original_pdf_file = 'PID.PDF'
temp_copied_pdf = 'TEMP_WORKING.PDF'
sumatra_path = r"C:\Program Files\SumatraPDF\SumatraPDF.exe"
log_file = 'search_log.txt'
temp_current_pdf = 'CURRENT_OUTPUT.PDF'

# === íŒŒì¼ ì¡´ì¬ í™•ì¸ ===
for file in [csv_file, original_pdf_file, sumatra_path]:
    if not os.path.exists(file):
        print(f"âŒ í•„ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {file}")
        exit()

# ì›ë³¸ PDF ë³µì‚¬ (ì›ë³¸ ë³´í˜¸)
shutil.copyfile(original_pdf_file, temp_copied_pdf)

# ë¡œê·¸ ì´ˆê¸°í™”
with open(log_file, 'w', encoding='utf-8') as log:
    log.write("ğŸ” ê²€ìƒ‰ê²°ê³¼ ë¡œê·¸\n\n")

# CSV íŒŒì¼ ì½ê¸°
with open(csv_file, 'r', newline='', encoding='utf-8-sig') as file:
    reader = csv.reader(file)
    count = 1

    for row in reader:
        if not row or not row[0].strip():
            continue

        vname = row[0].strip()
        print(f"\n[{count}] VNAME ê²€ìƒ‰: {vname}")

        try:
            with fitz.open(temp_copied_pdf) as src_doc:
                found = False

                for i, page in enumerate(src_doc):
                    text_instances = page.search_for(vname)
                    if text_instances:
                        found = True

                        # ìƒˆ ë¬¸ì„œ ìƒì„± (í•´ë‹¹ í˜ì´ì§€ ì „ì²´ ë³µì‚¬)
                        new_doc = fitz.open()
                        new_doc.insert_pdf(src_doc, from_page=i, to_page=i)

                        # í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
                        new_page = new_doc[0]
                        for rect in text_instances:
                            highlight = new_page.add_highlight_annot(rect)
                            highlight.update()

                        new_doc.save(temp_current_pdf)
                        new_doc.close()
                        break

            # ë¡œê·¸ ê¸°ë¡
            with open(log_file, 'a', encoding='utf-8') as log:
                if found:
                    log.write(f"[{count}] {vname} â†’ âœ… FOUND\n")
                else:
                    log.write(f"[{count}] {vname} â†’ âŒ NOT FOUND\n")

            # SumatraPDFë¡œ ë³´ì—¬ì£¼ê¸° (í™•ëŒ€ ì—†ì´ ê¸°ë³¸ìœ¼ë¡œ)
            if found:
                subprocess.Popen([
                    sumatra_path, "-reuse-instance", os.path.abspath(temp_current_pdf)
                ], shell=False)

            input("â†’ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê²€ìƒ‰ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...")

        except Exception as e:
            print(f"â€¼ ì˜¤ë¥˜ ë°œìƒ: {e}")

        count += 1

# ì„ì‹œíŒŒì¼ ì •ë¦¬
for temp_file in [temp_copied_pdf, temp_current_pdf]:
    try:
        os.remove(temp_file)
    except:
        pass

print("\nğŸ¯ ëª¨ë“  ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ ì¢…ë£Œ.")
