import csv
import fitz  # PyMuPDF
import os
import subprocess
import time

# === ì„¤ì • ===
csv_file = 'VALVELIST.CSV'
original_pdf_file = 'PID.PDF'
sumatra_path = r"C:\Program Files\SumatraPDF\SumatraPDF.exe"
log_file = 'search_log.txt'
temp_current_pdf = 'CURRENT_OUTPUT.PDF'

# íŒŒì¼ í™•ì¸
for file in [csv_file, original_pdf_file, sumatra_path]:
    if not os.path.exists(file):
        print(f"âŒ í•„ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {file}")
        exit()

# ë¡œê·¸ ì´ˆê¸°í™”
with open(log_file, 'w', encoding='utf-8') as log:
    log.write("ê²€ìƒ‰ê²°ê³¼ ë¡œê·¸\n\n")

# CSV íŒŒì¼ ì½ê¸°
with open(csv_file, 'r', newline='', encoding='utf-8-sig') as file:
    reader = csv.reader(file)
    count = 1

    for row in reader:
        if not row or not row[0].strip():
            continue

        vname = row[0].strip()
        print(f"\n[{count}] VNAME ê²€ìƒ‰ ì‹œì‘: {vname}")

        src_doc = fitz.open(original_pdf_file)
        found = False

        for i, page in enumerate(src_doc):
            text_instances = page.search_for(vname)
            if text_instances:
                found = True
                first_rect = text_instances[0]

                # ì›ë³¸ í˜ì´ì§€ë¥¼ í†µì§¸ë¡œ ë³µì‚¬
                new_doc = fitz.open()
                new_doc.insert_pdf(src_doc, from_page=i, to_page=i)
                copied_page = new_doc[0]

                # í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
                copied_page.add_highlight_annot(first_rect)

                new_doc.save(temp_current_pdf, garbage=4, deflate=True)
                new_doc.close()
                break

        src_doc.close()

        with open(log_file, 'a', encoding='utf-8') as log:
            if found:
                log.write(f"[{count}] {vname} â†’ FOUND\n")
            else:
                log.write(f"[{count}] {vname} â†’ NOT FOUND\n")

        if found:
            try:
                subprocess.Popen([
                    sumatra_path, "-reuse-instance", "-zoom", "200", os.path.abspath(temp_current_pdf)
                ], shell=False)
                time.sleep(0.5)
            except Exception as e:
                print(f"âŒ SumatraPDF ì‹¤í–‰ ì‹¤íŒ¨: {e}")

        input("â†’ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê²€ìƒ‰ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...")
        count += 1

print("\nğŸ¯ ëª¨ë“  ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ.")
