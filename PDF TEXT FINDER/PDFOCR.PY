from pdf2image import convert_from_path
from PyPDF2 import PdfWriter, PdfReader
import pytesseract
from PIL import Image, ImageFilter
import tkinter as tk
from tkinter import filedialog
import os
import io

# ê³ ì •ëœ Tesseract ì˜µì…˜ ì„¤ì • (LSTM + ë‹¨ì¼ ì»¬ëŸ¼ í…ìŠ¤íŠ¸ ì¸ì‹)
custom_config = r'--oem 1 --psm 6'

def run_ocr_with_preprocessing():
    root = tk.Tk()
    root.withdraw()

    pdf_path = filedialog.askopenfilename(
        title="OCR ì²˜ë¦¬í•  PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”",
        filetypes=[("PDF files", "*.pdf")]
    )
    if not pdf_path:
        print("âŒ PDF íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    base, ext = os.path.splitext(pdf_path)
    output_path = base + "_OCR.pdf"

    try:
        print(f"â¡ï¸ PDF â†’ ì´ë¯¸ì§€ ë³€í™˜ ì¤‘: {pdf_path}")
        images = convert_from_path(
            pdf_path,
            dpi=400,  # ğŸ“Œ ê³ í•´ìƒë„ ë³€í™˜
            poppler_path=r"C:\poppler-24.08.0\Library\bin"
        )

        writer = PdfWriter()

        for i, img in enumerate(images, 1):
            print(f"ğŸ“„ í˜ì´ì§€ {i}/{len(images)} OCR ì¤‘...")

            # ğŸ“Œ ì „ì²˜ë¦¬: í‘ë°± ë³€í™˜ + ìƒ¤í”„ë‹
            img = img.convert("L").filter(ImageFilter.SHARPEN)

            # OCR ìˆ˜í–‰
            pdf_bytes = pytesseract.image_to_pdf_or_hocr(
                img, extension='pdf', lang='eng', config=custom_config
            )
            reader = PdfReader(io.BytesIO(pdf_bytes))
            writer.add_page(reader.pages[0])

        with open(output_path, "wb") as f:
            writer.write(f)

        print(f"âœ… OCR ì™„ë£Œ: {output_path}")

    except Exception as e:
        print("âŒ OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e)

if __name__ == "__main__":
    run_ocr_with_preprocessing()
