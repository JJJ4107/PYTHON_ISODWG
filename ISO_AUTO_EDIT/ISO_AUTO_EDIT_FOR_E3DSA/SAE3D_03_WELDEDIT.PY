import ezdxf
import os
import math
from ezdxf.math import Vec2
import tkinter as tk
from tkinter import filedialog

### DXF íŒŒì¼ ì—¬ëŸ¬ ê°œ ì„ íƒ í•¨ìˆ˜ ###
def select_dxf_files():
    root = tk.Tk()
    root.withdraw()
    file_paths = filedialog.askopenfilenames(
        title="DXF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”",
        filetypes=[("DXF Files", "*.dxf")]
    )
    root.destroy()
    if not file_paths:
        print("âŒ ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        exit()
    return file_paths

### ìœ í‹¸ í•¨ìˆ˜ë“¤ ###
def distance(p1, p2):
    if isinstance(p1, Vec2) and isinstance(p2, Vec2):
        return math.hypot(p2.x - p1.x, p2.y - p1.y)
    return math.hypot(p2[0] - p1[0], p2[1] - p1[1])

def midpoint(points):
    x = sum(p[0] for p in points) / len(points)
    y = sum(p[1] for p in points) / len(points)
    return (x, y)

def polyline_length(pl):
    try:
        if pl.dxftype() == 'LWPOLYLINE':
            points = [p[:2] for p in pl.get_points()]
        elif pl.dxftype() == 'POLYLINE':
            points = []
            for v in pl.vertices:
                if hasattr(v.dxf, 'location'):
                    pt = (v.dxf.location.x, v.dxf.location.y)
                    points.append(pt)
            if not points:
                return 0
        else:
            return 0
        return sum(distance(points[i], points[i+1]) for i in range(len(points)-1))
    except Exception:
        return 0

def get_poly_points(pl):
    try:
        if pl.dxftype() == 'LWPOLYLINE':
            points = list(pl.get_points())
            points = [pt for pt in points if abs(pt[0]) > 1e-8 or abs(pt[1]) > 1e-8]
            return points
        elif pl.dxftype() == 'POLYLINE':
            pts = []
            for v in pl.vertices:
                if hasattr(v.dxf, 'location'):
                    x, y = v.dxf.location.x, v.dxf.location.y
                    if abs(x) > 1e-8 or abs(y) > 1e-8:
                        pts.append((x, y, 0, 0))
            return pts
        else:
            return []
    except Exception:
        return []

def is_valid_center(center):
    if center is None:
        return False
    x, y = center
    if abs(x) < 1e-5 and abs(y) < 1e-5:
        return False
    if abs(x) > 1e5 or abs(y) > 1e5:
        return False
    return True

def is_nearly_same_points(points, tol=0.05):
    if len(points) < 2:
        return True
    base = points[0][:2]
    for pt in points[1:]:
        if distance(base, pt[:2]) > tol:
            return False
    return True

### WELDSYMBOL ê¸°ëŠ¥ - WELD ë ˆì´ì–´ 7ê°œ ì  ì°¾ì•„ì„œ ì› ê·¸ë¦¬ê¸° ###
def process_weldsymbol(doc):
    msp = doc.modelspace()
    to_delete = []
    weld_count = 0

    print("ğŸ” WELD ë ˆì´ì–´ì˜ 7ê°œ ì  í´ë¦¬ë¼ì¸ ê²€ìƒ‰ ì¤‘...")

    for weld in list(msp.query('LWPOLYLINE POLYLINE')):
        # 7ê°œ ì ì¸ì§€ í™•ì¸
        points = get_poly_points(weld)
        if len(points) != 7:
            continue
        
        # ëª¨ë“  ì ì´ ê±°ì˜ ê°™ì€ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
        if is_nearly_same_points(points):
            continue
        
        # ì ë“¤ ê°„ ê±°ë¦¬ê°€ ë„ˆë¬´ ë©€ì§€ ì•Šì€ì§€ í™•ì¸ (2mm ì´ë‚´)
        too_far = False
        for i in range(6):
            d = distance(points[i][:2], points[i+1][:2])
            if d > 2.0:
                too_far = True
                break
        if too_far:
            continue
        
        # ì¤‘ì‹¬ì  ê³„ì‚°
        weld_center = midpoint([pt[:2] for pt in points])
        if not is_valid_center(weld_center):
            continue
        
        # í´ë¦¬ë¼ì¸ ê¸¸ì´ í™•ì¸
        length = polyline_length(weld)
        if length < 1 or length > 100:
            continue

        print(f"âœ… WELD í´ë¦¬ë¼ì¸ ë°œê²¬: ì¤‘ì‹¬({weld_center[0]:.2f}, {weld_center[1]:.2f})")

        # ì‘ì€ ë¼ì¸ë“¤ ì°¾ê¸° (3mm ì´ë‚´ì˜ ì§§ì€ ì„ ë“¤)
        short_plines = []
        for pl in msp.query('LWPOLYLINE POLYLINE LINE'):
            if pl == weld:
                continue
            pts = get_poly_points(pl)
            if len(pts) != 2:
                continue
            # WELD ì ë“¤ê³¼ ê°€ê¹Œìš´ì§€ í™•ì¸
            if any(distance(pt[:2], wp[:2]) <= 3.0 for pt in pts for wp in points):
                if polyline_length(pl) <= 2.8:
                    short_plines.append(pl)

        print(f"   ì‘ì€ ë¼ì¸ {len(short_plines)}ê°œ ë°œê²¬")

        # ë©”ì¸ ì› ê·¸ë¦¬ê¸° (ë°˜ì§€ë¦„ 1mm)
        main_circle = msp.add_circle(center=weld_center, radius=1, dxfattribs={"color": 2})
        main_circle.dxf.lineweight = 20

        # SW/OW ë ˆì´ì–´ ê²°ì • (ì‘ì€ ë¼ì¸ì´ 5ê°œ ì´ìƒì´ë©´ SW, ì•„ë‹ˆë©´ OW)
        main_circle.dxf.layer = "SW" if len(short_plines) >= 5 else "OW"
        print(f"   ë©”ì¸ ì› ê·¸ë¦¬ê¸° ì™„ë£Œ: ë ˆì´ì–´ {main_circle.dxf.layer}")

        # linetypeì´ BYLAYERì¸ ê²½ìš° ì•ˆìª½ì— ì—¬ëŸ¬ ê°œì˜ ì› ê·¸ë¦¬ê¸°
        if hasattr(weld.dxf, 'linetype') and weld.dxf.linetype.upper() == "BYLAYER":
            for r in [0.85, 0.7, 0.55, 0.4, 0.25]:
                inner = msp.add_circle(center=weld_center, radius=r, dxfattribs={"color": 2})
                inner.dxf.lineweight = 20
            print(f"   ë‚´ë¶€ ì› 5ê°œ ì¶”ê°€ ê·¸ë¦¬ê¸° ì™„ë£Œ")

        # ì‚­ì œí•  ì—”í‹°í‹° ëª©ë¡ì— ì¶”ê°€
        to_delete.append(weld)
        to_delete.extend(short_plines)
        weld_count += 1

    # ì—”í‹°í‹° ì‚­ì œ
    deleted_count = 0
    for ent in to_delete:
        try:
            msp.delete_entity(ent)
            deleted_count += 1
        except Exception:
            pass

    print(f"\nğŸ“Š ì²˜ë¦¬ ê²°ê³¼:")
    print(f"   ì²˜ë¦¬ëœ WELD í´ë¦¬ë¼ì¸: {weld_count}ê°œ")
    print(f"   ì‚­ì œëœ ì—”í‹°í‹°: {deleted_count}ê°œ")
    print(f"   ìƒì„±ëœ ì›: {weld_count}ê°œ (SW/OW ë ˆì´ì–´)")

### ë©”ì¸ ì‹¤í–‰ ###
if __name__ == "__main__":
    filepaths = select_dxf_files()
    
    for filepath in filepaths:
        try:
            print(f"\n{'='*60}")
            print(f"ğŸ“‚ íŒŒì¼ ì²˜ë¦¬: {filepath}")
            print(f"{'='*60}")
            
            # DXF íŒŒì¼ ì½ê¸°
            doc = ezdxf.readfile(filepath)
            
            # WELD ë ˆì´ì–´ ì²˜ë¦¬
            process_weldsymbol(doc)
            
            # ì¶œë ¥ íŒŒì¼ëª… ìƒì„±
            basename = os.path.splitext(os.path.basename(filepath))[0]
            output_dir = os.path.dirname(filepath)
            output_path = os.path.join(output_dir, basename + "_WELD.dxf")
            
            # íŒŒì¼ ì €ì¥
            try:
                doc.saveas(output_path)
                print(f"\nâœ… ì €ì¥ ì™„ë£Œ: {output_path}")
            except PermissionError:
                # ê¶Œí•œ ì˜¤ë¥˜ ì‹œ ë°”íƒ•í™”ë©´ì— ì €ì¥
                import getpass
                username = getpass.getuser()
                desktop_path = f"C:/Users/{username}/Desktop/{basename}_WELD.dxf"
                try:
                    doc.saveas(desktop_path)
                    print(f"\nâœ… ê¶Œí•œ ì˜¤ë¥˜ë¡œ ë°”íƒ•í™”ë©´ì— ì €ì¥: {desktop_path}")
                except Exception:
                    # í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì €ì¥
                    current_dir_path = f"./{basename}_WELD.dxf"
                    try:
                        doc.saveas(current_dir_path)
                        print(f"\nâœ… í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì €ì¥: {current_dir_path}")
                    except Exception as e:
                        print(f"\nâŒ ì €ì¥ ì‹¤íŒ¨: {e}")
            
        except Exception as e:
            print(f"\nâŒ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            continue
    
    print(f"\n{'='*60}")
    print("ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ!")
    print(f"{'='*60}")