import os
import sys
import tkinter as tk
from tkinter import filedialog, messagebox
import json

# DXF íŒŒì¼ ì²˜ë¦¬ë¥¼ ìœ„í•œ ezdxf ë¼ì´ë¸ŒëŸ¬ë¦¬
try:
    import ezdxf
    EZDXF_AVAILABLE = True
except ImportError:
    EZDXF_AVAILABLE = False
    print("ezdxf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì¹˜í•˜ì„¸ìš”: pip install ezdxf")

class DXFColorProcessor:
    def __init__(self):
        self.current_dir = os.path.dirname(os.path.abspath(__file__))
        self.config_file = os.path.join(self.current_dir, "dxf_color_config.json")
        self.last_dxf_dir = self.load_last_directory()
        
        # DXF ìƒ‰ìƒ ì½”ë“œ
        self.COLOR_WHITE = 7
        self.COLOR_YELLOW = 2
        self.COLOR_GREEN = 3
        self.COLOR_CYAN = 4
        
    def load_last_directory(self):
        """ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©í•œ ë””ë ‰í† ë¦¬ ë¡œë“œ"""
        try:
            if os.path.exists(self.config_file):
                with open(self.config_file, 'r') as f:
                    config = json.load(f)
                    return config.get('last_dxf_dir', self.current_dir)
        except:
            pass
        return self.current_dir
    
    def save_last_directory(self, directory):
        """ë§ˆì§€ë§‰ ì‚¬ìš© ë””ë ‰í† ë¦¬ ì €ì¥"""
        try:
            config = {'last_dxf_dir': directory}
            with open(self.config_file, 'w') as f:
                json.dump(config, f)
        except:
            pass
    
    def select_dxf_files(self):
        """DXF íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì"""
        root = tk.Tk()
        root.withdraw()
        
        initial_dir = self.last_dxf_dir if os.path.exists(self.last_dxf_dir) else self.current_dir
        
        files = filedialog.askopenfilenames(
            title="ì²˜ë¦¬í•  DXF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)",
            filetypes=[("DXF files", "*.dxf"), ("All files", "*.*")],
            initialdir=initial_dir
        )
        
        root.destroy()
        
        if files:
            self.last_dxf_dir = os.path.dirname(files[0])
            self.save_last_directory(self.last_dxf_dir)
        
        return list(files)
    
    def get_clean_filename(self, original_file):
        """íŒŒì¼ëª…ì—ì„œ _ ë’¤ì˜ ë‚´ìš©ì„ ì œê±°í•˜ê³  ACEPLANTë¥¼ ì¶”ê°€í•œ ì´ë¦„ ë°˜í™˜"""
        dir_name = os.path.dirname(original_file)
        base_name = os.path.splitext(os.path.basename(original_file))[0]
        
        # _ ë¬¸ìê°€ ìˆìœ¼ë©´ ê·¸ ì•ê¹Œì§€ë§Œ ì‚¬ìš©
        if '_' in base_name:
            base_name = base_name.split('_')[0]
        
        # ë¹ˆ ë¬¸ìì—´ì´ ë˜ë©´ ì›ë³¸ ì´ë¦„ ì‚¬ìš©
        if not base_name:
            base_name = os.path.splitext(os.path.basename(original_file))[0]
        
        # ACEPLANT ì¶”ê°€
        clean_name = base_name + 'ACEPLANT.dxf'
        return os.path.join(dir_name, clean_name)
    
    def get_polyline_vertex_count(self, entity):
        """í´ë¦¬ë¼ì¸ì˜ ì •ì  ê°œìˆ˜ë¥¼ ë°˜í™˜"""
        try:
            if entity.dxftype() == 'LWPOLYLINE':
                return len(list(entity.get_points()))
            elif entity.dxftype() == 'POLYLINE':
                return len(list(entity.vertices))
            else:
                return 0
        except:
            return 0
    
    def has_pipe_text_nearby(self, line_entity, doc, search_radius=50):
        """LINE ê·¼ì²˜ì— 'PIPE TEXT'ë¥¼ í¬í•¨í•˜ëŠ” í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸"""
        try:
            # LINEì˜ ì¤‘ì  ê³„ì‚°
            if hasattr(line_entity.dxf, 'start') and hasattr(line_entity.dxf, 'end'):
                mid_x = (line_entity.dxf.start[0] + line_entity.dxf.end[0]) / 2
                mid_y = (line_entity.dxf.start[1] + line_entity.dxf.end[1]) / 2
            else:
                return False
            
            # ëª¨ë“  í…ìŠ¤íŠ¸ ì—”í‹°í‹° ê²€ìƒ‰
            for entity in doc.modelspace():
                if entity.dxftype() in ['TEXT', 'MTEXT']:
                    text_content = ""
                    if entity.dxftype() == 'TEXT':
                        text_content = entity.dxf.text.upper() if hasattr(entity.dxf, 'text') else ""
                    elif entity.dxftype() == 'MTEXT':
                        text_content = entity.text.upper() if hasattr(entity, 'text') else ""
                    
                    if 'PIPE TEXT' in text_content:
                        # í…ìŠ¤íŠ¸ ìœ„ì¹˜ í™•ì¸
                        if hasattr(entity.dxf, 'insert'):
                            text_x = entity.dxf.insert[0]
                            text_y = entity.dxf.insert[1]
                            
                            # ê±°ë¦¬ ê³„ì‚°
                            distance = ((text_x - mid_x)**2 + (text_y - mid_y)**2)**0.5
                            if distance <= search_radius:
                                return True
            
            return False
        except:
            return False
    
    def has_text_layer_nearby(self, polyline_entity, doc, layer_name, search_radius=50):
        """í´ë¦¬ë¼ì¸ ê·¼ì²˜ì— íŠ¹ì • ë ˆì´ì–´ì˜ í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸"""
        try:
            # í´ë¦¬ë¼ì¸ì˜ ì¤‘ì  ê³„ì‚°
            points = []
            if polyline_entity.dxftype() == 'LWPOLYLINE':
                points = list(polyline_entity.get_points())
            elif polyline_entity.dxftype() == 'POLYLINE':
                points = [(v.dxf.location[0], v.dxf.location[1]) for v in polyline_entity.vertices]
            
            if not points:
                return False
            
            # ì¤‘ì  ê³„ì‚°
            mid_x = sum(p[0] for p in points) / len(points)
            mid_y = sum(p[1] for p in points) / len(points)
            
            # ëª¨ë“  í…ìŠ¤íŠ¸ ì—”í‹°í‹° ê²€ìƒ‰
            for entity in doc.modelspace():
                if entity.dxftype() in ['TEXT', 'MTEXT']:
                    # í…ìŠ¤íŠ¸ì˜ ë ˆì´ì–´ í™•ì¸
                    if hasattr(entity.dxf, 'layer') and entity.dxf.layer.upper() == layer_name.upper():
                        # í…ìŠ¤íŠ¸ ìœ„ì¹˜ í™•ì¸
                        if hasattr(entity.dxf, 'insert'):
                            text_x = entity.dxf.insert[0]
                            text_y = entity.dxf.insert[1]
                            
                            # ê±°ë¦¬ ê³„ì‚°
                            distance = ((text_x - mid_x)**2 + (text_y - mid_y)**2)**0.5
                            if distance <= search_radius:
                                return True
            
            return False
        except:
            return False
    
    def process_dxf_colors(self, dxf_file):
        """DXF íŒŒì¼ì˜ ìƒ‰ìƒ ë³€ê²½ ì²˜ë¦¬"""
        if not EZDXF_AVAILABLE:
            print(f"  âœ— ezdxf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ì–´ ìƒ‰ìƒ ë³€ê²½ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
            return False
            
        try:
            print(f"\nìƒ‰ìƒ ë³€ê²½ ì¤‘: {os.path.basename(dxf_file)}")
            
            # DXF íŒŒì¼ ì½ê¸°
            doc = ezdxf.readfile(dxf_file)
            
            text_count = 0
            line_count = 0
            pipe_text_line_count = 0
            pipe_layer_count = 0
            itemno_count = 0
            olet_count = 0
            polyline_3pt_count = 0
            tee_polyline_count = 0
            wdc_circle_count = 0
            
            # ëª¨ë“  ìŠ¤í˜ì´ìŠ¤ì˜ ì—”í‹°í‹°ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
            def process_entities(entities, space_name=""):
                nonlocal text_count, line_count, pipe_text_line_count, pipe_layer_count, itemno_count, olet_count, polyline_3pt_count, tee_polyline_count, wdc_circle_count
                
                for entity in entities:
                    try:
                        layer_name = entity.dxf.layer.upper() if hasattr(entity.dxf, 'layer') else ""
                        
                        # 1. ëª¨ë“  TEXT ì—”í‹°í‹°ë¥¼ YELLOWë¡œ ë³€ê²½
                        if entity.dxftype() in ['TEXT', 'MTEXT']:
                            entity.dxf.color = self.COLOR_YELLOW
                            text_count += 1
                        
                        # 2. itemnoì™€ ITNO ë ˆì´ì–´ëŠ” í°ìƒ‰ìœ¼ë¡œ
                        elif layer_name in ['ITEMNO', 'ITNO']:
                            entity.dxf.color = self.COLOR_WHITE
                            itemno_count += 1
                        
                        # 3. OLET, WOLET, REDU, VALV ë ˆì´ì–´ëŠ” YELLOWë¡œ
                        elif layer_name in ['OLET', 'WOLET', 'REDU', 'VALV']:
                            entity.dxf.color = self.COLOR_YELLOW
                            olet_count += 1
                        
                        # 4. LINE ì²˜ë¦¬
                        elif entity.dxftype() == 'LINE':
                            # ë ˆì´ì–´ ì´ë¦„ì— 'PIPE'ê°€ í¬í•¨ëœ LINEì€ GREENìœ¼ë¡œ
                            if 'PIPE' in layer_name:
                                entity.dxf.color = self.COLOR_GREEN
                                pipe_layer_count += 1
                            # PIPE TEXTê°€ í¬í•¨ëœ LINEì€ GREENìœ¼ë¡œ
                            elif self.has_pipe_text_nearby(entity, doc):
                                entity.dxf.color = self.COLOR_GREEN
                                pipe_text_line_count += 1
                        
                        # 5. POLYLINE/LWPOLYLINE ì²˜ë¦¬
                        elif entity.dxftype() in ['POLYLINE', 'LWPOLYLINE']:
                            # ë ˆì´ì–´ ì´ë¦„ì— 'PIPE'ê°€ í¬í•¨ëœ í´ë¦¬ë¼ì¸ì€ GREENìœ¼ë¡œ
                            if 'PIPE' in layer_name:
                                entity.dxf.color = self.COLOR_GREEN
                                pipe_layer_count += 1
                            # TEE ë ˆì´ì–´ TEXTê°€ ê·¼ì²˜ì— ìˆëŠ” í´ë¦¬ë¼ì¸ì€ CYANìœ¼ë¡œ
                            elif self.has_text_layer_nearby(entity, doc, 'TEE'):
                                entity.dxf.color = self.COLOR_CYAN
                                tee_polyline_count += 1
                            # GREEN ìƒ‰ìƒì˜ PL2 ë ˆì´ì–´ëŠ” í°ìƒ‰ìœ¼ë¡œ
                            elif layer_name == 'PL2' and hasattr(entity.dxf, 'color') and entity.dxf.color == self.COLOR_GREEN:
                                entity.dxf.color = self.COLOR_WHITE
                                line_count += 1
                            # 3ì  í´ë¦¬ë¼ì¸ìœ¼ë¡œ YELLOW ìƒ‰ìƒì˜ GT_1 ë ˆì´ì–´ëŠ” í°ìƒ‰ìœ¼ë¡œ
                            elif layer_name == 'GT_1' and hasattr(entity.dxf, 'color') and entity.dxf.color == self.COLOR_YELLOW:
                                vertex_count = self.get_polyline_vertex_count(entity)
                                if vertex_count == 3:
                                    entity.dxf.color = self.COLOR_WHITE
                                    polyline_3pt_count += 1
                            # ê¸°ì¡´ ê·œì¹™: CYAN, GREEN, YELLOW ìƒ‰ìƒì˜ GT_1 ë˜ëŠ” PL2 ë ˆì´ì–´ì˜ ë¼ì¸ë“¤ì„ í°ìƒ‰ìœ¼ë¡œ
                            elif layer_name in ['GT_1', 'PL2']:
                                if hasattr(entity.dxf, 'color') and entity.dxf.color in [self.COLOR_CYAN, self.COLOR_GREEN, self.COLOR_YELLOW]:
                                    # ìœ„ì˜ íŠ¹ë³„ ê·œì¹™ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
                                    if not (layer_name == 'PL2' and entity.dxf.color == self.COLOR_GREEN) and \
                                       not (layer_name == 'GT_1' and entity.dxf.color == self.COLOR_YELLOW and self.get_polyline_vertex_count(entity) == 3):
                                        entity.dxf.color = self.COLOR_WHITE
                                        line_count += 1
                        
                        # 6. CIRCLE ì²˜ë¦¬ - WDC ë ˆì´ì–´ì˜ ì›ì€ í°ìƒ‰ìœ¼ë¡œ
                        elif entity.dxftype() == 'CIRCLE':
                            if layer_name == 'WDC':
                                entity.dxf.color = self.COLOR_WHITE
                                wdc_circle_count += 1
                    
                    except Exception as e:
                        print(f"    ê²½ê³ : {space_name} ì—”í‹°í‹° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            
            # ëª¨ë¸ìŠ¤í˜ì´ìŠ¤ ì²˜ë¦¬
            process_entities(doc.modelspace(), "ëª¨ë¸ìŠ¤í˜ì´ìŠ¤")
            
            # í˜ì´í¼ìŠ¤í˜ì´ìŠ¤ ì²˜ë¦¬
            for layout in doc.layouts:
                if layout.name != 'Model':
                    process_entities(layout, f"ë ˆì´ì•„ì›ƒ '{layout.name}'")
            
            # ë¸”ë¡ ë‚´ë¶€ ì²˜ë¦¬
            for block in doc.blocks:
                process_entities(block, f"ë¸”ë¡ '{block.name}'")
            
            # ëª¨ë“  ë ˆì´ì–´ë¥¼ ACEPLANTë¡œ ë³€ê²½
            print(f"  ë ˆì´ì–´ ì´ë¦„ ë³€ê²½ ì¤‘...")
            
            # ëª¨ë“  ì—”í‹°í‹°ì˜ ë ˆì´ì–´ë¥¼ ACEPLANTë¡œ ë³€ê²½
            for entity in doc.modelspace():
                entity.dxf.layer = "ACEPLANT"
            
            # í˜ì´í¼ìŠ¤í˜ì´ìŠ¤ì˜ ì—”í‹°í‹°ë„ ì²˜ë¦¬
            for layout in doc.layouts:
                if layout.name != 'Model':
                    for entity in layout:
                        try:
                            entity.dxf.layer = "ACEPLANT"
                        except:
                            pass
            
            # ë¸”ë¡ ë‚´ë¶€ì˜ ì—”í‹°í‹°ë„ ì²˜ë¦¬
            for block in doc.blocks:
                for entity in block:
                    try:
                        entity.dxf.layer = "ACEPLANT"
                    except:
                        pass
            
            # ê¸°ì¡´ ë ˆì´ì–´ë“¤ ì‚­ì œ (ACEPLANTì™€ 0 ë ˆì´ì–´ ì œì™¸)
            layers_to_delete = []
            for layer in doc.layers:
                if layer.dxf.name not in ['ACEPLANT', '0']:
                    layers_to_delete.append(layer.dxf.name)
            
            # ACEPLANT ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if 'ACEPLANT' not in [layer.dxf.name for layer in doc.layers]:
                doc.layers.new(name='ACEPLANT')
            
            # ë¶ˆí•„ìš”í•œ ë ˆì´ì–´ ì‚­ì œ
            for layer_name in layers_to_delete:
                try:
                    doc.layers.remove(layer_name)
                except:
                    pass
            
            # ìµœì¢… íŒŒì¼ëª… ìƒì„±
            final_path = self.get_clean_filename(dxf_file)
            
            # íŒŒì¼ ì €ì¥ (ë°±ì—… ì—†ì´)
            # ì„ì‹œ íŒŒì¼ë¡œ ë¨¼ì € ì €ì¥
            temp_file = final_path + '.tmp'
            doc.saveas(temp_file)
            
            # ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì‚­ì œ
            if os.path.exists(final_path):
                os.remove(final_path)
            
            # ì„ì‹œ íŒŒì¼ì„ ìµœì¢… íŒŒì¼ë¡œ ì´ë¦„ ë³€ê²½
            os.rename(temp_file, final_path)
            
            print(f"  âœ“ ìƒ‰ìƒ ë³€ê²½ ì™„ë£Œ:")
            print(f"    - TEXTë¥¼ YELLOWë¡œ ë³€ê²½: {text_count}ê°œ")
            print(f"    - PIPE TEXT ê·¼ì²˜ LINEì„ GREENìœ¼ë¡œ ë³€ê²½: {pipe_text_line_count}ê°œ")
            print(f"    - 'PIPE' í¬í•¨ ë ˆì´ì–´ì˜ LINE/í´ë¦¬ë¼ì¸ì„ GREENìœ¼ë¡œ ë³€ê²½: {pipe_layer_count}ê°œ")
            print(f"    - TEE ë ˆì´ì–´ TEXT ê·¼ì²˜ í´ë¦¬ë¼ì¸ì„ CYANìœ¼ë¡œ ë³€ê²½: {tee_polyline_count}ê°œ")
            print(f"    - itemno/ITNO ë ˆì´ì–´ë¥¼ WHITEë¡œ ë³€ê²½: {itemno_count}ê°œ")
            print(f"    - OLET/WOLET/REDU/VALV ë ˆì´ì–´ë¥¼ YELLOWë¡œ ë³€ê²½: {olet_count}ê°œ")
            print(f"    - WDC ë ˆì´ì–´ì˜ ì›ì„ WHITEë¡œ ë³€ê²½: {wdc_circle_count}ê°œ")
            print(f"    - GT_1 ë ˆì´ì–´ì˜ 3ì  í´ë¦¬ë¼ì¸ì„ WHITEë¡œ ë³€ê²½: {polyline_3pt_count}ê°œ")
            print(f"    - ê¸°íƒ€ GT_1/PL2 ë ˆì´ì–´ì˜ ì„ ì„ WHITEë¡œ ë³€ê²½: {line_count}ê°œ")
            print(f"    - ëª¨ë“  ë ˆì´ì–´ë¥¼ ACEPLANTë¡œ ë³€ê²½")
            print(f"  âœ“ ì €ì¥ ì™„ë£Œ: {os.path.basename(final_path)}")
            
            return True
            
        except Exception as e:
            print(f"  âœ— ì²˜ë¦¬ ì‹¤íŒ¨: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
    
    def process_files(self):
        """ì„ íƒëœ DXF íŒŒì¼ë“¤ì„ ì²˜ë¦¬"""
        files = self.select_dxf_files()
        
        if not files:
            messagebox.showinfo("ì•Œë¦¼", "ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        print(f"\n{'='*60}")
        print(f"DXF ìƒ‰ìƒ ë³€ê²½ ì²˜ë¦¬ ì‹œì‘")
        print(f"ì„ íƒëœ íŒŒì¼: {len(files)}ê°œ")
        for f in files:
            print(f"  - {os.path.basename(f)}")
        print(f"{'='*60}")
        
        success_count = 0
        
        # ê° íŒŒì¼ì„ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬
        for file_idx, dxf_file in enumerate(files, 1):
            print(f"\n[íŒŒì¼ {file_idx}/{len(files)}]")
            if self.process_dxf_colors(dxf_file):
                success_count += 1
        
        # ê²°ê³¼ ì¶œë ¥
        print(f"\n\n{'='*60}")
        print("ğŸ‰ ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        print(f"\nì²˜ë¦¬ ê²°ê³¼:")
        print(f"  ì „ì²´ íŒŒì¼: {len(files)}ê°œ")
        print(f"  ì„±ê³µ: {success_count}ê°œ")
        print(f"  ì‹¤íŒ¨: {len(files) - success_count}ê°œ")
        print(f"{'='*60}")

def main():
    print("DXF ìƒ‰ìƒ ë³€ê²½ í”„ë¡œê·¸ë¨ v3.2")
    print("="*60)
    print("ì´ í”„ë¡œê·¸ë¨ì˜ ê¸°ëŠ¥:")
    print("  1. ëª¨ë“  TEXTë¥¼ YELLOW ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  2. 'PIPE TEXT' ê·¼ì²˜ì˜ LINEì„ GREEN ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  3. ë ˆì´ì–´ ì´ë¦„ì— 'PIPE'ê°€ í¬í•¨ëœ ëª¨ë“  LINE/í´ë¦¬ë¼ì¸ì„ GREENìœ¼ë¡œ ë³€ê²½")
    print("  4. TEE ë ˆì´ì–´ TEXT ê·¼ì²˜ì˜ í´ë¦¬ë¼ì¸ì„ CYAN ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  5. itemno/ITNO ë ˆì´ì–´ë¥¼ WHITE ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  6. OLET/WOLET/REDU/VALV ë ˆì´ì–´ë¥¼ YELLOW ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  7. WDC ë ˆì´ì–´ì˜ ì›(CIRCLE)ì„ WHITE ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½")
    print("  8. GREEN ìƒ‰ìƒì˜ PL2 ë ˆì´ì–´ë¥¼ WHITEë¡œ ë³€ê²½")
    print("  9. YELLOW ìƒ‰ìƒì˜ GT_1 ë ˆì´ì–´ 3ì  í´ë¦¬ë¼ì¸ì„ WHITEë¡œ ë³€ê²½")
    print("  10. ëª¨ë“  ë ˆì´ì–´ë¥¼ ACEPLANTë¡œ í†µì¼")
    print("  11. íŒŒì¼ëª…ì—ì„œ _ ë’¤ì˜ ë‚´ìš©ì„ ì œê±°í•˜ê³  'ACEPLANT.dxf'ë¡œ ì €ì¥")
    print("      ì˜ˆ: drawing_Final_v2.dxf â†’ drawingACEPLANT.dxf")
    print("="*60)
    
    # ezdxf ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
    if not EZDXF_AVAILABLE:
        print("\nâš  ezdxf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤!")
        print("ì„¤ì¹˜ ëª…ë ¹ì–´: pip install ezdxf")
        return
    
    try:
        # ë²„ì „ í™•ì¸
        version = None
        if hasattr(ezdxf, '__version__'):
            version = ezdxf.__version__
        elif hasattr(ezdxf, 'version'):
            if isinstance(ezdxf.version, str):
                version = ezdxf.version
            elif hasattr(ezdxf.version, '__version__'):
                version = ezdxf.version.__version__
        
        if version:
            print(f"ezdxf ë²„ì „: {version}")
        else:
            print("ezdxfê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"ezdxf ë²„ì „ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {e}")
        print("ezdxfê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
    
    processor = DXFColorProcessor()
    
    try:
        processor.process_files()
    except KeyboardInterrupt:
        print("\n\nì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"\n\nì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()