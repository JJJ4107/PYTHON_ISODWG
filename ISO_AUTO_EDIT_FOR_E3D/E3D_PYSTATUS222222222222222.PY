#!/usr/bin/env python3
"""
Git ì €ì¥ì†Œ í˜„í™© í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
ì‚¬ìš©ì: ì¥í˜ì¤€
ì´ë©”ì¼: jj@aceplant.co.kr
"""

import subprocess
import os
from datetime import datetime
from pathlib import Path

class GitStatusChecker:
    def __init__(self):
        self.current_dir = Path.cwd()
        # Windows í™˜ê²½ì—ì„œ Git ì¶œë ¥ ì¸ì½”ë”© ì„¤ì •
        os.environ['LANG'] = 'en_US.UTF-8'
        os.environ['LC_ALL'] = 'en_US.UTF-8'
        
    def run_command(self, command):
        """Git ëª…ë ¹ì–´ ì‹¤í–‰"""
        try:
            # Windows í™˜ê²½ì—ì„œ UTF-8 ì¸ì½”ë”© ì‚¬ìš©
            result = subprocess.run(
                command, 
                shell=True, 
                capture_output=True, 
                text=True,
                encoding='utf-8',
                errors='replace'  # ë””ì½”ë”© ì—ëŸ¬ ì‹œ ëŒ€ì²´ ë¬¸ì ì‚¬ìš©
            )
            
            # stdoutì´ Noneì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
            stdout = result.stdout if result.stdout is not None else ""
            return result.returncode == 0, stdout
        except Exception as e:
            return False, str(e)
    
    def check_git_repo(self):
        """Git ì €ì¥ì†Œì¸ì§€ í™•ì¸"""
        if not os.path.exists(os.path.join(self.current_dir, '.git')):
            print("âŒ í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.")
            return False
        return True
    
    def show_user_info(self):
        """í˜„ì¬ Git ì‚¬ìš©ì ì •ë³´ í‘œì‹œ"""
        print("\nğŸ‘¤ Git ì‚¬ìš©ì ì •ë³´:")
        print("=" * 50)
        
        success, name = self.run_command("git config user.name")
        if success:
            print(f"ì´ë¦„: {name.strip()}")
        
        success, email = self.run_command("git config user.email")
        if success:
            print(f"ì´ë©”ì¼: {email.strip()}")
    
    def show_repository_info(self):
        """ì €ì¥ì†Œ ê¸°ë³¸ ì •ë³´ í‘œì‹œ"""
        print("\nğŸ“ ì €ì¥ì†Œ ì •ë³´:")
        print("=" * 50)
        print(f"ìœ„ì¹˜: {self.current_dir}")
        
        # í˜„ì¬ ë¸Œëœì¹˜
        success, branch = self.run_command("git branch --show-current")
        if success:
            print(f"í˜„ì¬ ë¸Œëœì¹˜: {branch.strip()}")
        
        # ëª¨ë“  ë¸Œëœì¹˜ ëª©ë¡
        success, branches = self.run_command("git branch -a")
        if success:
            print("\në¸Œëœì¹˜ ëª©ë¡:")
            for line in branches.strip().split('\n'):
                print(f"  {line}")
    
    def show_remote_info(self):
        """ì›ê²© ì €ì¥ì†Œ ì •ë³´ í‘œì‹œ"""
        print("\nğŸŒ ì›ê²© ì €ì¥ì†Œ ì •ë³´:")
        print("=" * 50)
        
        success, remotes = self.run_command("git remote -v")
        if success and remotes.strip():
            print(remotes.strip())
        else:
            print("ì„¤ì •ëœ ì›ê²© ì €ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    def show_status(self):
        """í˜„ì¬ ì‘ì—… ìƒíƒœ í‘œì‹œ"""
        print("\nğŸ“Š í˜„ì¬ ì‘ì—… ìƒíƒœ:")
        print("=" * 50)
        
        success, status = self.run_command("git status")
        if success:
            print(status.strip())
    
    def show_commit_history(self, limit=10):
        """ì»¤ë°‹ íˆìŠ¤í† ë¦¬ í‘œì‹œ"""
        print(f"\nğŸ“œ ìµœê·¼ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ (ìµœê·¼ {limit}ê°œ):")
        print("=" * 50)
        
        # ë” ìì„¸í•œ ë¡œê·¸ í˜•ì‹
        log_format = "--pretty=format:'%C(yellow)%h%C(reset) - %C(green)(%cr)%C(reset) %C(bold blue)<%an>%C(reset) %s'"
        success, log = self.run_command(f"git log {log_format} -{limit}")
        
        if success and log.strip():
            print(log.strip())
        else:
            print("ì»¤ë°‹ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    def show_file_statistics(self):
        """íŒŒì¼ í†µê³„ í‘œì‹œ"""
        print("\nğŸ“ˆ íŒŒì¼ í†µê³„:")
        print("=" * 50)
        
        # ì „ì²´ íŒŒì¼ ìˆ˜
        success, files = self.run_command("git ls-files")
        if success:
            file_list = files.strip().split('\n') if files.strip() else []
            total_files = len(file_list)
            print(f"Gitì— ì¶”ì ë˜ëŠ” ì „ì²´ íŒŒì¼ ìˆ˜: {total_files}")
            
            # íŒŒì¼ íƒ€ì…ë³„ í†µê³„
            file_types = {}
            for file in file_list:
                ext = os.path.splitext(file)[1].lower()
                if ext:
                    file_types[ext] = file_types.get(ext, 0) + 1
            
            if file_types:
                print("\níŒŒì¼ íƒ€ì…ë³„ í†µê³„:")
                for ext, count in sorted(file_types.items(), key=lambda x: x[1], reverse=True)[:10]:
                    print(f"  {ext}: {count}ê°œ")
            
            # Python íŒŒì¼ í†µê³„
            py_files = [f for f in file_list if f.lower().endswith('.py')]
            if py_files:
                print(f"\nPython íŒŒì¼: {len(py_files)}ê°œ")
                print("ìµœê·¼ ì¶”ê°€ëœ Python íŒŒì¼ (ìµœëŒ€ 5ê°œ):")
                for file in py_files[-5:]:
                    print(f"  - {file}")
    
    def show_uncommitted_changes(self):
        """ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ í‘œì‹œ"""
        print("\nâš ï¸  ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­:")
        print("=" * 50)
        
        # ìŠ¤í…Œì´ì§•ëœ íŒŒì¼
        success, staged = self.run_command("git diff --cached --name-status")
        if success and staged.strip():
            print("\nìŠ¤í…Œì´ì§•ëœ íŒŒì¼:")
            for line in staged.strip().split('\n'):
                parts = line.split('\t', 1)
                if len(parts) == 2:
                    status, filename = parts
                    status_text = {'A': 'ì¶”ê°€', 'M': 'ìˆ˜ì •', 'D': 'ì‚­ì œ'}.get(status, status)
                    print(f"  [{status_text}] {filename}")
                else:
                    print(f"  {line}")
        
        # ìˆ˜ì •ëœ íŒŒì¼
        success, modified = self.run_command("git diff --name-status")
        if success and modified.strip():
            print("\nìˆ˜ì •ëœ íŒŒì¼ (ìŠ¤í…Œì´ì§• ì•ˆë¨):")
            for line in modified.strip().split('\n'):
                parts = line.split('\t', 1)
                if len(parts) == 2:
                    status, filename = parts
                    status_text = {'M': 'ìˆ˜ì •', 'D': 'ì‚­ì œ'}.get(status, status)
                    print(f"  [{status_text}] {filename}")
                else:
                    print(f"  {line}")
        
        # ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼
        success, untracked = self.run_command("git ls-files --others --exclude-standard")
        if success and untracked.strip():
            untracked_files = untracked.strip().split('\n')
            print(f"\nì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼ ({len(untracked_files)}ê°œ):")
            for file in untracked_files[:10]:
                print(f"  - {file}")
            if len(untracked_files) > 10:
                print(f"  ... ê·¸ ì™¸ {len(untracked_files) - 10}ê°œ")
    
    def show_last_push_info(self):
        """ë§ˆì§€ë§‰ í‘¸ì‹œ ì •ë³´ í‘œì‹œ"""
        print("\nğŸ“¤ ë§ˆì§€ë§‰ í‘¸ì‹œ ì •ë³´:")
        print("=" * 50)
        
        # í˜„ì¬ ë¸Œëœì¹˜ì˜ ì—…ìŠ¤íŠ¸ë¦¼ í™•ì¸
        success, upstream = self.run_command("git rev-parse --abbrev-ref --symbolic-full-name @{u}")
        if success and upstream.strip():
            # ë¡œì»¬ê³¼ ì›ê²©ì˜ ì°¨ì´ í™•ì¸
            success, ahead = self.run_command("git rev-list --count @{u}..HEAD")
            success2, behind = self.run_command("git rev-list --count HEAD..@{u}")
            
            if success and success2:
                ahead_count = int(ahead.strip()) if ahead.strip() else 0
                behind_count = int(behind.strip()) if behind.strip() else 0
                
                print(f"ì—…ìŠ¤íŠ¸ë¦¼ ë¸Œëœì¹˜: {upstream.strip()}")
                
                if ahead_count == 0 and behind_count == 0:
                    print("âœ… ë¡œì»¬ê³¼ ì›ê²©ì´ ë™ê¸°í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
                else:
                    if ahead_count > 0:
                        print(f"â¬†ï¸  í‘¸ì‹œë˜ì§€ ì•Šì€ ì»¤ë°‹: {ahead_count}ê°œ")
                    if behind_count > 0:
                        print(f"â¬‡ï¸  í’€ ë°›ì•„ì•¼ í•  ì»¤ë°‹: {behind_count}ê°œ")
        else:
            print("ì—…ìŠ¤íŠ¸ë¦¼ ë¸Œëœì¹˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    def run(self):
        """ì „ì²´ ìƒíƒœ í™•ì¸ ì‹¤í–‰"""
        print("ğŸ” Git ì €ì¥ì†Œ í˜„í™© í™•ì¸")
        print("=" * 70)
        print(f"í™•ì¸ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        if not self.check_git_repo():
            return
        
        self.show_user_info()
        self.show_repository_info()
        self.show_remote_info()
        self.show_status()
        self.show_file_statistics()
        self.show_uncommitted_changes()
        self.show_last_push_info()
        self.show_commit_history()
        
        print("\n" + "=" * 70)
        print("âœ¨ Git í˜„í™© í™•ì¸ ì™„ë£Œ!")

def main():
    checker = GitStatusChecker()
    checker.run()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ ì‚¬ìš©ìê°€ ì‘ì—…ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")