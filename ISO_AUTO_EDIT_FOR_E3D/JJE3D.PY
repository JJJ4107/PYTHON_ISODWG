import os
import shutil
import tkinter as tk
from tkinter import filedialog
import sys

def process_py_files():
    """ë””ë ‰í† ë¦¬ë¥¼ ì„ íƒí•˜ê³  .py íŒŒì¼ë“¤ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜"""
    
    # tkinter ë£¨íŠ¸ ìœˆë„ìš° ìƒì„± ë° ì„¤ì •
    root = tk.Tk()
    root.withdraw()  # ë©”ì¸ ìœˆë„ìš° ìˆ¨ê¸°ê¸°
    root.wm_attributes('-topmost', 1)  # ì°½ì„ ìµœìƒìœ„ë¡œ
    
    # í¬ì»¤ìŠ¤ ì„¤ì •ì„ ìœ„í•œ ë”ë¯¸ ìœˆë„ìš° ìƒì„±
    root.update_idletasks()
    root.update()
    
    # ë””ë ‰í† ë¦¬ ì„ íƒ ëŒ€í™”ìƒì ì—´ê¸°
    selected_dir = filedialog.askdirectory(
        title="ì²˜ë¦¬í•  ë””ë ‰í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”",
        parent=root
    )
    
    # root ìœˆë„ìš° ì¢…ë£Œ
    root.destroy()
    
    if not selected_dir:
        print("ë””ë ‰í† ë¦¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return
    
    print(f"\nì„ íƒëœ ë””ë ‰í† ë¦¬: {selected_dir}")
    print("-" * 50)
    
    # ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜ ì¹´ìš´í„°
    renamed_count = 0
    copied_count = 0
    skipped_count = 0
    
    # ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  íŒŒì¼ í™•ì¸
    files = [f for f in os.listdir(selected_dir) if os.path.isfile(os.path.join(selected_dir, f))]
    
    for filename in files:
        # .py íŒŒì¼ì´ê³  ì• 2ìë¦¬ê°€ ìˆ«ìì¸ì§€ í™•ì¸
        if filename.lower().endswith('.py') and len(filename) >= 2:
            # íŒŒì¼ëª… ì• 2ìë¦¬ê°€ ìˆ«ìì¸ì§€ í™•ì¸
            if filename[:2].isdigit():
                old_path = os.path.join(selected_dir, filename)
                
                try:
                    # 1. ì›ë³¸ íŒŒì¼ ì´ë¦„ ë³€ê²½: E3D_ + ì›ë˜íŒŒì¼ì´ë¦„
                    # ì´ë¯¸ E3D_ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ëŠ” ê±´ë„ˆë›°ê¸°
                    if not filename.startswith("E3D_"):
                        new_filename = f"E3D_{filename}"
                        new_path = os.path.join(selected_dir, new_filename)
                        
                        # ëŒ€ìƒ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                        if os.path.exists(new_path):
                            print(f"âš ï¸  ì´ë¯¸ ì¡´ì¬í•¨: {new_filename}")
                            skipped_count += 1
                        else:
                            os.rename(old_path, new_path)
                            print(f"âœ… ì´ë¦„ ë³€ê²½: {filename} â†’ {new_filename}")
                            renamed_count += 1
                            
                            # ì´ë¦„ ë³€ê²½ í›„ì˜ ê²½ë¡œ ì—…ë°ì´íŠ¸
                            old_path = new_path
                            filename = new_filename
                    else:
                        # ì´ë¯¸ E3D_ë¡œ ì‹œì‘í•˜ëŠ” íŒŒì¼
                        print(f"â­ï¸  ê±´ë„ˆëœ€ (ì´ë¯¸ E3D_ ì ‘ë‘ì‚¬): {filename}")
                        skipped_count += 1
                    
                    # 2. íŒŒì¼ ë³µì‚¬: E3D_ON_ + ì›ë˜íŒŒì¼ì´ë¦„
                    # E3D_ê°€ ì´ë¯¸ ë¶™ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                    if filename.startswith("E3D_"):
                        original_name = filename[4:]  # E3D_ ì œê±°
                    else:
                        original_name = filename
                        
                    copy_filename = f"E3D_ON_{original_name}"
                    copy_path = os.path.join(selected_dir, copy_filename)
                    
                    # ë³µì‚¬ë³¸ì´ ì´ë¯¸ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ë³µì‚¬
                    if not os.path.exists(copy_path):
                        shutil.copy2(old_path, copy_path)
                        print(f"âœ… ë³µì‚¬ ìƒì„±: {copy_filename}")
                        copied_count += 1
                    else:
                        print(f"âš ï¸  ë³µì‚¬ë³¸ ì´ë¯¸ ì¡´ì¬: {copy_filename}")
                        
                except Exception as e:
                    print(f"âŒ ì˜¤ë¥˜ ë°œìƒ ({filename}): {str(e)}")
    
    # ì²˜ë¦¬ ê²°ê³¼ ì¶œë ¥
    print("\n" + "="*50)
    print(f"ğŸ¯ ì²˜ë¦¬ ì™„ë£Œ!")
    print(f"âœ… ì´ë¦„ ë³€ê²½ëœ íŒŒì¼ ìˆ˜: {renamed_count}")
    print(f"âœ… ë³µì‚¬ ìƒì„±ëœ íŒŒì¼ ìˆ˜: {copied_count}")
    print(f"â­ï¸  ê±´ë„ˆë›´ íŒŒì¼ ìˆ˜: {skipped_count}")
    print("="*50)

def test_tkinter():
    """tkinterê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸"""
    try:
        root = tk.Tk()
        root.destroy()
        return True
    except Exception as e:
        print(f"tkinter ì˜¤ë¥˜: {e}")
        return False

def main():
    """í”„ë¡œê·¸ë¨ ì‹¤í–‰"""
    print("\n" + "="*50)
    print("Python íŒŒì¼ ì´ë¦„ ë³€ê²½ ë° ë³µì‚¬ í”„ë¡œê·¸ë¨")
    print("="*50)
    print("\nì´ í”„ë¡œê·¸ë¨ì€ ì„ íƒí•œ ë””ë ‰í† ë¦¬ì—ì„œ:")
    print("1. íŒŒì¼ëª… ì• 2ìë¦¬ê°€ ìˆ«ìì¸ .py íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤")
    print("2. í•´ë‹¹ íŒŒì¼ëª…ì„ 'E3D_' + ì›ë˜ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤")
    print("3. ê° íŒŒì¼ì„ 'E3D_ON_' + ì›ë˜ì´ë¦„ìœ¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤")
    print("-" * 50)
    
    # tkinter í…ŒìŠ¤íŠ¸
    if not test_tkinter():
        print("\nâš ï¸  tkinterê°€ ì œëŒ€ë¡œ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        print("ëŒ€ì‹  ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        selected_dir = input("ë””ë ‰í† ë¦¬ ê²½ë¡œ: ").strip()
        
        if os.path.isdir(selected_dir):
            print(f"\nì„ íƒëœ ë””ë ‰í† ë¦¬: {selected_dir}")
            print("-" * 50)
            
            # ì§ì ‘ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            process_py_files_manual(selected_dir)
        else:
            print("ì˜¬ë°”ë¥¸ ë””ë ‰í† ë¦¬ ê²½ë¡œê°€ ì•„ë‹™ë‹ˆë‹¤.")
    else:
        input("\nê³„ì†í•˜ë ¤ë©´ Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”...")
        process_py_files()
    
    input("\nì¢…ë£Œí•˜ë ¤ë©´ Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”...")

def process_py_files_manual(selected_dir):
    """ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ë°›ì€ ë””ë ‰í† ë¦¬ ì²˜ë¦¬"""
    # ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜ ì¹´ìš´í„°
    renamed_count = 0
    copied_count = 0
    skipped_count = 0
    
    # ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  íŒŒì¼ í™•ì¸
    files = [f for f in os.listdir(selected_dir) if os.path.isfile(os.path.join(selected_dir, f))]
    
    for filename in files:
        # .py íŒŒì¼ì´ê³  ì• 2ìë¦¬ê°€ ìˆ«ìì¸ì§€ í™•ì¸
        if filename.lower().endswith('.py') and len(filename) >= 2:
            # íŒŒì¼ëª… ì• 2ìë¦¬ê°€ ìˆ«ìì¸ì§€ í™•ì¸
            if filename[:2].isdigit():
                old_path = os.path.join(selected_dir, filename)
                
                try:
                    # 1. ì›ë³¸ íŒŒì¼ ì´ë¦„ ë³€ê²½: E3D_ + ì›ë˜íŒŒì¼ì´ë¦„
                    if not filename.startswith("E3D_"):
                        new_filename = f"E3D_{filename}"
                        new_path = os.path.join(selected_dir, new_filename)
                        
                        if os.path.exists(new_path):
                            print(f"âš ï¸  ì´ë¯¸ ì¡´ì¬í•¨: {new_filename}")
                            skipped_count += 1
                        else:
                            os.rename(old_path, new_path)
                            print(f"âœ… ì´ë¦„ ë³€ê²½: {filename} â†’ {new_filename}")
                            renamed_count += 1
                            
                            old_path = new_path
                            filename = new_filename
                    else:
                        print(f"â­ï¸  ê±´ë„ˆëœ€ (ì´ë¯¸ E3D_ ì ‘ë‘ì‚¬): {filename}")
                        skipped_count += 1
                    
                    # 2. íŒŒì¼ ë³µì‚¬: E3D_ON_ + ì›ë˜íŒŒì¼ì´ë¦„
                    if filename.startswith("E3D_"):
                        original_name = filename[4:]
                    else:
                        original_name = filename
                        
                    copy_filename = f"E3D_ON_{original_name}"
                    copy_path = os.path.join(selected_dir, copy_filename)
                    
                    if not os.path.exists(copy_path):
                        shutil.copy2(old_path, copy_path)
                        print(f"âœ… ë³µì‚¬ ìƒì„±: {copy_filename}")
                        copied_count += 1
                    else:
                        print(f"âš ï¸  ë³µì‚¬ë³¸ ì´ë¯¸ ì¡´ì¬: {copy_filename}")
                        
                except Exception as e:
                    print(f"âŒ ì˜¤ë¥˜ ë°œìƒ ({filename}): {str(e)}")
    
    # ì²˜ë¦¬ ê²°ê³¼ ì¶œë ¥
    print("\n" + "="*50)
    print(f"ğŸ¯ ì²˜ë¦¬ ì™„ë£Œ!")
    print(f"âœ… ì´ë¦„ ë³€ê²½ëœ íŒŒì¼ ìˆ˜: {renamed_count}")
    print(f"âœ… ë³µì‚¬ ìƒì„±ëœ íŒŒì¼ ìˆ˜: {copied_count}")
    print(f"â­ï¸  ê±´ë„ˆë›´ íŒŒì¼ ìˆ˜: {skipped_count}")
    print("="*50)

if __name__ == "__main__":
    main()