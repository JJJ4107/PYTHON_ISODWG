#!/usr/bin/env python3
"""
VSCodeì—ì„œ í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  Python íŒŒì¼ì„ Gitì— ì—…ë¡œë“œí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
ê¸°ë³¸ ì‚¬ìš©ì: JJJ4107
ê¸°ë³¸ ì´ë©”ì¼: jj@aceplant.co.kr
ê¸°ë³¸ ì €ì¥ì†Œ: https://github.com/JJJ4107/PYTHON_ISODWG.git
"""

import os
import subprocess
import sys
from pathlib import Path
from datetime import datetime

class GitPythonUploader:
    def __init__(self, user_name="JJJ4107", user_email="jj@aceplant.co.kr", github_repo_url="https://github.com/JJJ4107/PYTHON_ISODWG.git"):
        self.user_name = user_name
        self.user_email = user_email
        self.github_repo_url = github_repo_url
        self.current_dir = Path.cwd()
        
    def run_command(self, command):
        """Git ëª…ë ¹ì–´ ì‹¤í–‰"""
        try:
            result = subprocess.run(command, shell=True, capture_output=True, text=True)
            if result.returncode == 0:
                return True, result.stdout
            else:
                return False, result.stderr
        except Exception as e:
            return False, str(e)
    
    def check_git_installed(self):
        """Git ì„¤ì¹˜ í™•ì¸"""
        success, _ = self.run_command("git --version")
        if not success:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Gitì„ ë¨¼ì € ì„¤ì¹˜í•´ì£¼ì„¸ìš”.")
            return False
        print("âœ… Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
        return True
    
    def init_git_repo(self):
        """Git ì €ì¥ì†Œ ì´ˆê¸°í™”"""
        if os.path.exists(os.path.join(self.current_dir, '.git')):
            print("âœ… Git ì €ì¥ì†Œê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            return True
        
        success, output = self.run_command("git init")
        if success:
            print("âœ… Git ì €ì¥ì†Œë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.")
            return True
        else:
            print(f"âŒ Git ì €ì¥ì†Œ ì´ˆê¸°í™” ì‹¤íŒ¨: {output}")
            return False
    
    def configure_git_user(self):
        """Git ì‚¬ìš©ì ì„¤ì •"""
        # ë¡œì»¬ ì €ì¥ì†Œì—ë§Œ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
        commands = [
            f'git config user.name "{self.user_name}"',
            f'git config user.email "{self.user_email}"'
        ]
        
        for cmd in commands:
            success, output = self.run_command(cmd)
            if not success:
                print(f"âŒ Git ì‚¬ìš©ì ì„¤ì • ì‹¤íŒ¨: {output}")
                return False
        
        print(f"âœ… Git ì‚¬ìš©ì ì„¤ì • ì™„ë£Œ: {self.user_name} <{self.user_email}>")
        return True
    
    def find_python_files(self):
        """í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  Python íŒŒì¼ ì°¾ê¸°"""
        python_files = []
        
        # .git í´ë”ì™€ __pycache__ í´ë”ëŠ” ì œì™¸
        exclude_dirs = {'.git', '__pycache__', 'venv', '.venv', 'env', '.env'}
        
        for root, dirs, files in os.walk(self.current_dir):
            # ì œì™¸í•  ë””ë ‰í† ë¦¬ ê±´ë„ˆë›°ê¸°
            dirs[:] = [d for d in dirs if d not in exclude_dirs]
            
            for file in files:
                # ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ .py ë˜ëŠ” .PY í™•ì¥ì í™•ì¸
                if file.lower().endswith('.py'):
                    relative_path = os.path.relpath(os.path.join(root, file), self.current_dir)
                    python_files.append(relative_path)
        
        return python_files
    
    def add_files_to_git(self, files):
        """íŒŒì¼ë“¤ì„ Gitì— ì¶”ê°€"""
        if not files:
            print("âŒ ì¶”ê°€í•  Python íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            
            # ë””ë²„ê¹…: í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ëª©ë¡ ì¶œë ¥
            print("\nğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ëª©ë¡:")
            try:
                all_files = []
                for file in os.listdir(self.current_dir):
                    if os.path.isfile(os.path.join(self.current_dir, file)):
                        all_files.append(file)
                
                if all_files:
                    for file in all_files[:10]:  # ì²˜ìŒ 10ê°œë§Œ í‘œì‹œ
                        print(f"   - {file}")
                    if len(all_files) > 10:
                        print(f"   ... ê·¸ ì™¸ {len(all_files) - 10}ê°œ íŒŒì¼")
                else:
                    print("   íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                    
                # Pythonì²˜ëŸ¼ ë³´ì´ëŠ” íŒŒì¼ í™•ì¸
                py_like_files = [f for f in all_files if 'py' in f.lower()]
                if py_like_files:
                    print(f"\nğŸ’¡ Pythonê³¼ ìœ ì‚¬í•œ íŒŒì¼ëª…: {py_like_files[:5]}")
                    
            except Exception as e:
                print(f"   ë””ë ‰í† ë¦¬ ì½ê¸° ì˜¤ë¥˜: {e}")
            
            return False
        
        print(f"\nğŸ“ {len(files)}ê°œì˜ Python íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤:")
        for file in files:
            print(f"   - {file}")
        
        # íŒŒì¼ë“¤ì„ í•˜ë‚˜ì”© ì¶”ê°€
        for file in files:
            success, output = self.run_command(f'git add "{file}"')
            if not success:
                print(f"âŒ íŒŒì¼ ì¶”ê°€ ì‹¤íŒ¨ ({file}): {output}")
                return False
        
        print(f"âœ… {len(files)}ê°œì˜ Python íŒŒì¼ì„ Gitì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.")
        return True
    
    def create_gitignore(self):
        """Python í”„ë¡œì íŠ¸ìš© .gitignore íŒŒì¼ ìƒì„±"""
        gitignore_content = """# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# PyInstaller
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
.hypothesis/
.pytest_cache/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
target/

# Jupyter Notebook
.ipynb_checkpoints

# pyenv
.python-version

# celery beat schedule file
celerybeat-schedule

# SageMath parsed files
*.sage.py

# Environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# IDE
.idea/
.vscode/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
"""
        
        gitignore_path = os.path.join(self.current_dir, '.gitignore')
        if not os.path.exists(gitignore_path):
            with open(gitignore_path, 'w', encoding='utf-8') as f:
                f.write(gitignore_content)
            print("âœ… .gitignore íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
            self.run_command("git add .gitignore")
    
    def commit_changes(self):
        """ë³€ê²½ì‚¬í•­ ì»¤ë°‹"""
        # ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
        success, output = self.run_command("git status --porcelain")
        if not output.strip():
            print("â„¹ï¸  ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
            return True
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        commit_message = f"Add Python files - {timestamp}"
        
        success, output = self.run_command(f'git commit -m "{commit_message}"')
        if success:
            print(f"âœ… ì»¤ë°‹ ì™„ë£Œ: {commit_message}")
            return True
        else:
            print(f"âŒ ì»¤ë°‹ ì‹¤íŒ¨: {output}")
            return False
    
    def setup_github_remote(self):
        """GitHub ì›ê²© ì €ì¥ì†Œ ì„¤ì •"""
        print("\nğŸ”§ GitHub ì›ê²© ì €ì¥ì†Œ ì„¤ì •")
        print("GitHub ì €ì¥ì†Œ URL í˜•ì‹:")
        print("  - HTTPS: https://github.com/ì‚¬ìš©ìëª…/ì €ì¥ì†Œëª….git")
        print("  - SSH: git@github.com:ì‚¬ìš©ìëª…/ì €ì¥ì†Œëª….git")
        
        # ê¸°ë³¸ URLì´ ìˆìœ¼ë©´ í‘œì‹œ
        if self.github_repo_url:
            print(f"\nê¸°ë³¸ ì €ì¥ì†Œ: {self.github_repo_url}")
            use_default = input("ê¸°ë³¸ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
            if use_default == 'y':
                github_url = self.github_repo_url
            else:
                github_url = input("GitHub ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
        else:
            github_url = input("\nGitHub ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ê±´ë„ˆë›°ê¸°): ").strip()
        
        if github_url:
            # ê¸°ì¡´ originì´ ìˆëŠ”ì§€ í™•ì¸
            success, output = self.run_command("git remote get-url origin")
            if success:
                print(f"ê¸°ì¡´ ì›ê²© ì €ì¥ì†Œ: {output.strip()}")
                response = input("ê¸°ì¡´ ì„¤ì •ì„ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                if response == 'y':
                    self.run_command("git remote remove origin")
                else:
                    return False
            
            # ìƒˆ ì›ê²© ì €ì¥ì†Œ ì¶”ê°€
            success, output = self.run_command(f"git remote add origin {github_url}")
            if success:
                print("âœ… GitHub ì›ê²© ì €ì¥ì†Œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                return True
            else:
                print(f"âŒ ì›ê²© ì €ì¥ì†Œ ì„¤ì • ì‹¤íŒ¨: {output}")
                return False
        
        return False
    
    def push_to_remote(self):
        """ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ (ì„ íƒì )"""
        # ì›ê²© ì €ì¥ì†Œê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        success, output = self.run_command("git remote -v")
        if not output.strip():
            print("\nâ„¹ï¸  ì›ê²© ì €ì¥ì†Œê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            # ìë™ìœ¼ë¡œ GitHub ì €ì¥ì†Œ ì„¤ì •
            if self.github_repo_url:
                print(f"ğŸ”§ GitHub ì €ì¥ì†Œë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤: {self.github_repo_url}")
                success, output = self.run_command(f"git remote add origin {self.github_repo_url}")
                if success:
                    print("âœ… GitHub ì›ê²© ì €ì¥ì†Œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                else:
                    print(f"âŒ ì›ê²© ì €ì¥ì†Œ ì„¤ì • ì‹¤íŒ¨: {output}")
                    return False
            else:
                # GitHub ì„¤ì • ì œì•ˆ
                response = input("GitHub ì €ì¥ì†Œë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                if response == 'y':
                    if not self.setup_github_remote():
                        return False
                else:
                    return True
        
        # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
        success, branch = self.run_command("git branch --show-current")
        if not success or not branch.strip():
            # ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ mainìœ¼ë¡œ ìƒì„±
            self.run_command("git checkout -b main")
            branch = "main"
        else:
            branch = branch.strip()
        
        print(f"\nğŸ“¤ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ ì¤€ë¹„ (ë¸Œëœì¹˜: {branch})")
        
        # ì›ê²© ì €ì¥ì†Œ ì •ë³´ í‘œì‹œ
        print("í˜„ì¬ ì„¤ì •ëœ ì›ê²© ì €ì¥ì†Œ:")
        self.run_command("git remote -v")
        
        response = input("\ní‘¸ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
        
        if response == 'y':
            # ì²« í‘¸ì‹œì¸ì§€ í™•ì¸
            success, _ = self.run_command(f"git ls-remote origin {branch}")
            
            if not success:
                # ì²« í‘¸ì‹œì¸ ê²½ìš°
                print("ğŸš€ ì²« ë²ˆì§¸ í‘¸ì‹œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤...")
                push_cmd = f"git push -u origin {branch}"
            else:
                # ê¸°ì¡´ ë¸Œëœì¹˜ê°€ ìˆëŠ” ê²½ìš°
                push_cmd = f"git push origin {branch}"
            
            success, output = self.run_command(push_cmd)
            if success:
                print("âœ… GitHubì— í‘¸ì‹œ ì™„ë£Œ!")
                print(f"ğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸: {self.get_github_url()}")
                return True
            else:
                if "authentication" in output.lower() or "permission" in output.lower():
                    print("\nâŒ ì¸ì¦ ì‹¤íŒ¨! GitHub ì¸ì¦ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
                    print("\nğŸ“ GitHub ì¸ì¦ ë°©ë²•:")
                    print("1. Personal Access Token ì‚¬ìš© (ê¶Œì¥):")
                    print("   - GitHub Settings > Developer settings > Personal access tokens")
                    print("   - 'Generate new token' í´ë¦­")
                    print("   - 'repo' ê¶Œí•œ ì²´í¬")
                    print("   - ìƒì„±ëœ í† í°ì„ ë¹„ë°€ë²ˆí˜¸ ëŒ€ì‹  ì‚¬ìš©")
                    print("\n2. SSH í‚¤ ì„¤ì •:")
                    print("   - ssh-keygen -t ed25519 -C \"your_email@example.com\"")
                    print("   - GitHub Settings > SSH and GPG keysì— ê³µê°œí‚¤ ì¶”ê°€")
                elif "rejected" in output.lower():
                    print("\nâŒ í‘¸ì‹œê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì›ê²© ì €ì¥ì†Œì— ë³€ê²½ì‚¬í•­ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    print("ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì›ê²© ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”:")
                    print(f"git pull origin {branch}")
                else:
                    print(f"âŒ í‘¸ì‹œ ì‹¤íŒ¨: {output}")
                return False
        else:
            print("â„¹ï¸  í‘¸ì‹œë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.")
            return True
    
    def get_github_url(self):
        """GitHub ì €ì¥ì†Œ ì›¹ URL ì¶”ì¶œ"""
        # ë¨¼ì € ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì—ì„œ í™•ì¸
        if self.github_repo_url:
            url = self.github_repo_url
            # .git ì œê±°
            if url.endswith(".git"):
                return url[:-4]
            return url
        
        # ì›ê²© ì €ì¥ì†Œì—ì„œ í™•ì¸
        success, output = self.run_command("git remote get-url origin")
        if success and output:
            url = output.strip()
            # SSH URLì„ HTTPS URLë¡œ ë³€í™˜
            if url.startswith("git@github.com:"):
                url = url.replace("git@github.com:", "https://github.com/")
            # .git ì œê±°
            if url.endswith(".git"):
                url = url[:-4]
            return url
        return ""
    
    def run(self):
        """ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰"""
        print("ğŸš€ Python íŒŒì¼ Git ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘")
        print(f"ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: {self.current_dir}\n")
        
        # 1. Git ì„¤ì¹˜ í™•ì¸
        if not self.check_git_installed():
            return
        
        # 2. Git ì €ì¥ì†Œ ì´ˆê¸°í™”
        if not self.init_git_repo():
            return
        
        # 3. Git ì‚¬ìš©ì ì„¤ì •
        if not self.configure_git_user():
            return
        
        # 4. .gitignore íŒŒì¼ ìƒì„±
        self.create_gitignore()
        
        # 5. Python íŒŒì¼ ì°¾ê¸°
        python_files = self.find_python_files()
        
        # 6. íŒŒì¼ë“¤ì„ Gitì— ì¶”ê°€
        if not self.add_files_to_git(python_files):
            return
        
        # 7. ì»¤ë°‹
        if not self.commit_changes():
            return
        
        # 8. í‘¸ì‹œ (ì„ íƒì )
        self.push_to_remote()
        
        print("\nâœ¨ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    uploader = GitPythonUploader()
    
    # ì‚¬ìš©ì ì •ë³´ í™•ì¸
    print("í˜„ì¬ ì„¤ì •ëœ ì‚¬ìš©ì ì •ë³´:")
    print(f"ì´ë¦„: {uploader.user_name}")
    print(f"ì´ë©”ì¼: {uploader.user_email}")
    print(f"GitHub ì €ì¥ì†Œ: {uploader.github_repo_url}")
    print("\në‹¤ë¥¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì‹œë ¤ë©´ 'n'ì„ ì…ë ¥í•˜ì„¸ìš”.")
    response = input("í˜„ì¬ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
    
    if response == 'n':
        name = input("Git ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: ")
        email = input("Git ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”: ")
        repo_url = input("GitHub ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­, ì—”í„°ë¡œ ê±´ë„ˆë›°ê¸°): ").strip()
        uploader = GitPythonUploader(name, email, repo_url if repo_url else None)
    
    print()
    uploader.run()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ ì‚¬ìš©ìê°€ ì‘ì—…ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        sys.exit(1)