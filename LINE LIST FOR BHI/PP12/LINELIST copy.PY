import fitz  # PyMuPDF
import csv
import os
import re
from collections import defaultdict
from tkinter import Tk, filedialog
from datetime import datetime

# ---------- íŒŒì¼ ë‹¤ì¤‘ ì„ íƒ ----------
root = Tk()
root.withdraw()
pdf_paths = filedialog.askopenfilenames(
    title="PDF íŒŒì¼ë“¤ì„ ì„ íƒí•˜ì„¸ìš”",
    filetypes=[("PDF files", "*.pdf")]
)
if not pdf_paths:
    print("PDF íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    exit()

# ---------- ì‚¬ê°í˜• ë°•ìŠ¤ í•˜ì´ë¼ì´íŠ¸ ----------
def highlight(page, rect, color, opacity=0.4):
    annot = page.add_rect_annot(rect)
    annot.set_colors(stroke=color, fill=color)
    annot.set_opacity(opacity)
    annot.update()

# ---------- ìì—° ì •ë ¬ì„ ìœ„í•œ í‚¤ ìƒì„± í•¨ìˆ˜ ----------
def natural_key(text):
    return [int(s) if s.isdigit() else s.lower() for s in re.split(r'(\d+)', text)]

# ---------- íŒ¨í„´ ì •ì˜ ----------
valve_pattern = re.compile(r'AA[0-9]{3,4}', re.IGNORECASE)
special_pattern = re.compile(r'(AJ|BJ|AT)[0-9]{3,4}', re.IGNORECASE)

# ---------- PDF ì²˜ë¦¬ ----------
for input_pdf_path in pdf_paths:
    input_pdf_name = os.path.basename(input_pdf_path)
    base_name = os.path.splitext(input_pdf_name)[0]
    folder = os.path.dirname(input_pdf_path)

    today_str = datetime.now().strftime("%Y%m%d")

    line_csv = os.path.join(folder, f"LINE_{base_name}_{today_str}.CSV")
    valve_csv = os.path.join(folder, f"VALVE_{base_name}_{today_str}.CSV")
    special_csv = os.path.join(folder, f"SPECIAL_{base_name}_{today_str}.CSV")
    output_pdf = os.path.join(folder, f"OUT_{base_name}_{today_str}.PDF")
    dup_pdf = os.path.join(folder, f"DUP_{base_name}_{today_str}.PDF")
    dup_csv_path = os.path.join(folder, f"DUP_{base_name}_{today_str}.CSV")

    doc = fitz.open(input_pdf_path)    # OUT ìš©
    doc2 = fitz.open(input_pdf_path)   # DUP ìš©

    line_list, valve_list, special_list = [], [], []
    line_no_rects = defaultdict(list)
    valve_no_rects = defaultdict(list)
    special_no_rects = defaultdict(list)

    for page_num, page in enumerate(doc, 1):
        words = page.get_text("words")
        for word in words:
            x0, y0, x1, y1, text = word[:5]
            if not text.strip():
                continue

            p1 = text.strip().split()[0].upper()
            rect = fitz.Rect(x0, y0, x1, y1)
            is_p1 = False

            # ----- P1ìœ¼ë¡œ ì¸ì •ë˜ëŠ” ê²½ìš°ë§Œ is_p1 = True -----
            if "BR" in p1 and "DN" in p1:
                dn_index = p1.find("DN")
                if dn_index != -1:
                    after_dn = p1[dn_index:].split()[0]
                    line_no = p1[:dn_index] + after_dn
                    line_list.append([line_no])
                    line_no_rects[line_no].append((page_num - 1, rect))
                    is_p1 = True
                    print(f"[{base_name}] LINE NO: {line_no}")
            elif valve_pattern.search(p1):
                valve_list.append([p1])
                valve_no_rects[p1].append((page_num - 1, rect))
                is_p1 = True
                print(f"[{base_name}] VALVE NO: {p1}")
            elif special_pattern.search(p1):
                special_list.append([p1])
                special_no_rects[p1].append((page_num - 1, rect))
                is_p1 = True
                print(f"[{base_name}] SPECIAL NO: {p1}")

            # OUT PDFëŠ” ìœ„ ì¡°ê±´ì— í•´ë‹¹(P1)í•˜ëŠ” ê²½ìš°ì—ë§Œ í•˜ì´ë¼ì´íŠ¸!
            if is_p1:
                highlight(page, rect, color=(0, 1, 0), opacity=0.2)

    # ì¤‘ë³µ ì²´í¬
    line_counts = defaultdict(int)
    for row in line_list:
        line_counts[row[0]] += 1
    line_list_dup = [row + ["ì¤‘ë³µ" if line_counts[row[0]] > 1 else ""] for row in line_list]

    valve_counts = defaultdict(int)
    for row in valve_list:
        valve_counts[row[0]] += 1
    valve_list_dup = [row + ["ì¤‘ë³µ" if valve_counts[row[0]] > 1 else ""] for row in valve_list]

    special_counts = defaultdict(int)
    for row in special_list:
        special_counts[row[0]] += 1
    special_list_dup = [row + ["ì¤‘ë³µ" if special_counts[row[0]] > 1 else ""] for row in special_list]

    # CSV ì €ì¥
    with open(line_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["LINE NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(line_list_dup, key=lambda x: natural_key(x[0])))

    with open(valve_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["VALVE NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(valve_list_dup, key=lambda x: natural_key(x[0])))

    with open(special_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["SPECIAL NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(special_list_dup, key=lambda x: natural_key(x[0])))

    # ì¤‘ë³µ í•­ëª©ë§Œ ë³‘í•©í•˜ì—¬ DUP CSV ì €ì¥
    dup_lines = [row for row in line_list_dup if row[1] == "ì¤‘ë³µ"]
    dup_valves = [row for row in valve_list_dup if row[1] == "ì¤‘ë³µ"]
    dup_specials = [row for row in special_list_dup if row[1] == "ì¤‘ë³µ"]
    max_len = max(len(dup_lines), len(dup_valves), len(dup_specials))
    dup_lines += [["", ""]] * (max_len - len(dup_lines))
    dup_valves += [["", ""]] * (max_len - len(dup_valves))
    dup_specials += [["", ""]] * (max_len - len(dup_specials))

    with open(dup_csv_path, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["LINE NO", "ì¤‘ë³µ", "VALVE NO", "ì¤‘ë³µ", "SPECIAL NO", "ì¤‘ë³µ"])
        for i in range(max_len):
            writer.writerow(dup_lines[i] + dup_valves[i] + dup_specials[i])

    print(f"ğŸ“ ì¤‘ë³µ í•­ëª© ì €ì¥ ì™„ë£Œ: {dup_csv_path}")

    # ì¤‘ë³µ í•˜ì´ë¼ì´íŠ¸ PDF (DUP)
    for key, rects in valve_no_rects.items():
        if valve_counts[key] > 1:
            for idx, (pg, rect) in enumerate(rects):
                page = doc2[pg]
                color = (0, 0, 1) if idx == 0 else (1, 0, 0)
                highlight(page, rect, color=color, opacity=0.4)

    for key, rects in line_no_rects.items():
        if line_counts[key] > 1:
            for idx, (pg, rect) in enumerate(rects):
                page = doc2[pg]
                color = (0, 0, 1) if idx == 0 else (1, 0, 0)
                highlight(page, rect, color=color, opacity=0.4)

    for key, rects in special_no_rects.items():
        if special_counts[key] > 1:
            for idx, (pg, rect) in enumerate(rects):
                page = doc2[pg]
                color = (0, 0, 1) if idx == 0 else (1, 0, 0)
                highlight(page, rect, color=color, opacity=0.4)

    doc2.save(dup_pdf)
    doc2.close()
    print(f"ğŸ¨ ì¤‘ë³µ í•˜ì´ë¼ì´íŠ¸ ì €ì¥ ì™„ë£Œ â†’ {dup_pdf}")

    # OUT PDF (P1ë§Œ í•˜ì´ë¼ì´íŠ¸) ì €ì¥
    doc.save(output_pdf)
    doc.close()
    print(f"ğŸ“„ ê¸°ë³¸ P1 í•˜ì´ë¼ì´íŠ¸ ì €ì¥ ì™„ë£Œ â†’ {output_pdf}\n")
