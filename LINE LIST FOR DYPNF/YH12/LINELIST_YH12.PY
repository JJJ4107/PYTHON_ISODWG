import fitz  # PyMuPDF
import csv
import os
import re
from collections import defaultdict
from tkinter import Tk, filedialog
from datetime import datetime

# ---------- íŒŒì¼ ë‹¤ì¤‘ ì„ íƒ ----------
root = Tk()
root.withdraw()
pdf_paths = filedialog.askopenfilenames(
    title="PDF íŒŒì¼ë“¤ì„ ì„ íƒí•˜ì„¸ìš”",
    filetypes=[("PDF files", "*.pdf")]
)
if not pdf_paths:
    print("PDF íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    exit()

# ---------- í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜ ----------
def highlight(page, rect, color, opacity=0.4):
    annot = page.add_rect_annot(rect)
    annot.set_colors(stroke=color, fill=color)
    annot.set_opacity(opacity)
    annot.update()

# ---------- ìì—° ì •ë ¬ ----------
def natural_key(text):
    return [int(s) if s.isdigit() else s.lower() for s in re.split(r'(\d+)', text)]

# ---------- SPECIAL íŒ¨í„´ ----------
special_pattern = re.compile(r'^(AJ|BJ|AT)[0-9]{3,4}', re.IGNORECASE)

# ---------- ì „ì²´ í†µí•© ë¦¬ìŠ¤íŠ¸ ----------
all_LINE, all_VALVE, all_SPECIAL = [], [], []

# ---------- PDF ì²˜ë¦¬ ----------
for input_pdf_path in pdf_paths:
    input_pdf_name = os.path.basename(input_pdf_path)
    base_name = os.path.splitext(input_pdf_name)[0]
    folder = os.path.dirname(input_pdf_path)
    today_str = datetime.now().strftime("%Y%m%d")

    # ê²°ê³¼ íŒŒì¼ ê²½ë¡œ ì„¤ì •
    line_csv = os.path.join(folder, f"LINE_{base_name}_{today_str}.CSV")
    valve_csv = os.path.join(folder, f"VALVE_{base_name}_{today_str}.CSV")
    special_csv = os.path.join(folder, f"SPECIAL_{base_name}_{today_str}.CSV")
    dup_csv_path = os.path.join(folder, f"DUP_{base_name}_{today_str}.CSV")
    output_pdf = os.path.join(folder, f"OUT_{base_name}_{today_str}.PDF")
    dup_pdf = os.path.join(folder, f"DUP_{base_name}_{today_str}.PDF")

    doc = fitz.open(input_pdf_path)
    doc2 = fitz.open(input_pdf_path)

    line_list, valve_list, special_list = [], [], []
    line_no_rects = defaultdict(list)
    valve_no_rects = defaultdict(list)
    special_no_rects = defaultdict(list)

    for page_num, page in enumerate(doc, 1):
        words = page.get_text("words")
        for w in words:
            x0, y0, x1, y1, text = w[:5]
            clean_text = text.strip().replace(" ", "")
            if len(clean_text) < 4:
                continue
            prefix4 = clean_text[:4].upper()

            rect = fitz.Rect(x0, y0, x1, y1)
            is_found = False

            # ---------- LINE NO ----------
            if len(prefix4) >= 4 and prefix4[3] == 'A' and len(clean_text) >= 9:
                full_line = f"1-62100-{clean_text}"
                line_list.append([full_line])
                line_no_rects[full_line].append((page_num - 1, rect))
                all_LINE.append([full_line])
                is_found = True
                print(f"[{base_name}] LINE NO: {full_line}")

            # ---------- VALVE NO ----------
            elif prefix4[0] == 'V':
                full_valve = f"1-62100-{clean_text}"
                valve_list.append([full_valve])
                valve_no_rects[full_valve].append((page_num - 1, rect))
                all_VALVE.append([full_valve])
                is_found = True
                print(f"[{base_name}] VALVE NO: {full_valve}")

            # ---------- SPECIAL NO ----------
            elif special_pattern.match(clean_text):
                special_list.append([clean_text])
                special_no_rects[clean_text].append((page_num - 1, rect))
                all_SPECIAL.append([clean_text])
                is_found = True
                print(f"[{base_name}] SPECIAL NO: {clean_text}")

            # ---------- í•˜ì´ë¼ì´íŠ¸ ----------
            if is_found:
                highlight(page, rect, color=(0, 1, 0), opacity=0.2)

    # ---------- ì¤‘ë³µ ì²´í¬ ë° CSV ì €ì¥ ----------
    def process_list(lst):
        counts = defaultdict(int)
        for row in lst:
            counts[row[0]] += 1
        return [row + ["ì¤‘ë³µ" if counts[row[0]] > 1 else ""] for row in lst], counts

    line_list_dup, line_counts = process_list(line_list)
    valve_list_dup, valve_counts = process_list(valve_list)
    special_list_dup, special_counts = process_list(special_list)

    with open(line_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["LINE NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(line_list_dup, key=lambda x: natural_key(x[0])))

    with open(valve_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["VALVE NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(valve_list_dup, key=lambda x: natural_key(x[0])))

    with open(special_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["SPECIAL NO", "ì¤‘ë³µ"])
        writer.writerows(sorted(special_list_dup, key=lambda x: natural_key(x[0])))

    # ---------- ì¤‘ë³µ ì „ìš© CSV ----------
    def extract_dups(lst):
        return [r for r in lst if r[1] == "ì¤‘ë³µ"]

    dup_lines = extract_dups(line_list_dup)
    dup_valves = extract_dups(valve_list_dup)
    dup_specials = extract_dups(special_list_dup)

    max_len = max(len(dup_lines), len(dup_valves), len(dup_specials))
    dup_lines += [["", ""]] * (max_len - len(dup_lines))
    dup_valves += [["", ""]] * (max_len - len(dup_valves))
    dup_specials += [["", ""]] * (max_len - len(dup_specials))

    with open(dup_csv_path, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["LINE NO", "ì¤‘ë³µ", "VALVE NO", "ì¤‘ë³µ", "SPECIAL NO", "ì¤‘ë³µ"])
        for i in range(max_len):
            writer.writerow(dup_lines[i] + dup_valves[i] + dup_specials[i])

    # ---------- ì¤‘ë³µ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ í‘œì‹œ ----------
    def highlight_duplicates(counts_dict, rects_dict):
        for key, rects in rects_dict.items():
            if counts_dict[key] > 1:
                for idx, (pg, rect) in enumerate(rects):
                    color = (0, 0, 1) if idx == 0 else (1, 0, 0)
                    highlight(doc2[pg], rect, color=color, opacity=0.4)

    highlight_duplicates(line_counts, line_no_rects)
    highlight_duplicates(valve_counts, valve_no_rects)
    highlight_duplicates(special_counts, special_no_rects)

    doc2.save(dup_pdf); doc2.close()
    print(f"ğŸ¨ ì¤‘ë³µ í•˜ì´ë¼ì´íŠ¸ ì €ì¥ ì™„ë£Œ â†’ {dup_pdf}")
    doc.save(output_pdf); doc.close()
    print(f"ğŸ“„ ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ ì €ì¥ ì™„ë£Œ â†’ {output_pdf}\n")

# ---------- í†µí•© CSV ì €ì¥ ----------
if any([all_LINE, all_VALVE, all_SPECIAL]):
    first_pdf = os.path.splitext(os.path.basename(pdf_paths[0]))[0]
    all_csv = os.path.join(os.path.dirname(pdf_paths[0]),
                           f"ALL_{first_pdf}_{datetime.now().strftime('%Y%m%d')}.CSV")
    with open(all_csv, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["LINE NO", "ì¤‘ë³µ"])
        writer.writerows(all_LINE)
        writer.writerow([])
        writer.writerow(["VALVE NO", "ì¤‘ë³µ"])
        writer.writerows(all_VALVE)
        writer.writerow([])
        writer.writerow(["SPECIAL NO", "ì¤‘ë³µ"])
        writer.writerows(all_SPECIAL)
    print(f"âœ… í†µí•© CSV ìƒì„±ë¨ â†’ {all_csv}")
