import os
import subprocess
import glob
from pathlib import Path
import sys

class GitPythonManager:
    def __init__(self, username="ì¥í˜ì¤€", email="jj@aceplant.co.kr"):
        self.username = username
        self.email = email
        self.current_dir = os.getcwd()
        
    def setup_git_user(self):
        """Git ì‚¬ìš©ì ì •ë³´ ì„¤ì •"""
        try:
            # Git ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
            result = subprocess.run(['git', 'config', '--global', 'user.name', self.username], 
                                  capture_output=True, text=True)
            if result.returncode == 0:
                print(f"âœ“ Git ì‚¬ìš©ì ì´ë¦„ ì„¤ì • ì™„ë£Œ: {self.username}")
            else:
                print(f"âš ï¸  Git ì‚¬ìš©ì ì´ë¦„ ì„¤ì • ì¤‘ ê²½ê³ : {result.stderr}")
            
            # Git ì‚¬ìš©ì ì´ë©”ì¼ ì„¤ì •
            result = subprocess.run(['git', 'config', '--global', 'user.email', self.email], 
                                  capture_output=True, text=True)
            if result.returncode == 0:
                print(f"âœ“ Git ì‚¬ìš©ì ì´ë©”ì¼ ì„¤ì • ì™„ë£Œ: {self.email}")
            else:
                print(f"âš ï¸  Git ì‚¬ìš©ì ì´ë©”ì¼ ì„¤ì • ì¤‘ ê²½ê³ : {result.stderr}")
            
            # ì„¤ì • í™•ì¸
            name_result = subprocess.run(['git', 'config', '--global', 'user.name'], 
                                       capture_output=True, text=True)
            email_result = subprocess.run(['git', 'config', '--global', 'user.email'], 
                                        capture_output=True, text=True)
            
            print(f"\ní˜„ì¬ Git ì„¤ì •:")
            
            # stdoutì´ Noneì´ ì•„ë‹Œì§€ í™•ì¸
            if name_result.stdout:
                print(f"  - ì‚¬ìš©ì: {name_result.stdout.strip()}")
            else:
                print(f"  - ì‚¬ìš©ì: ì„¤ì •ë˜ì§€ ì•ŠìŒ")
                
            if email_result.stdout:
                print(f"  - ì´ë©”ì¼: {email_result.stdout.strip()}")
            else:
                print(f"  - ì´ë©”ì¼: ì„¤ì •ë˜ì§€ ì•ŠìŒ")
            
        except FileNotFoundError:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            print("   Gitì„ ë¨¼ì € ì„¤ì¹˜í•´ì£¼ì„¸ìš”: https://git-scm.com/downloads")
            return False
        except Exception as e:
            print(f"âŒ Git ì„¤ì • ì˜¤ë¥˜: {e}")
            return False
        return True
    
    def list_python_files(self):
        """í˜„ì¬ ë””ë ‰í† ë¦¬ì™€ í•˜ìœ„ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  Python íŒŒì¼ ëª©ë¡ ì‘ì„±"""
        print(f"\nğŸ“ í˜„ì¬ ìœ„ì¹˜: {self.current_dir}")
        print("Python íŒŒì¼ ëª©ë¡:")
        print("-" * 50)
        
        python_files = []
        
        try:
            # globì„ ì‚¬ìš©í•˜ì—¬ ì¬ê·€ì ìœ¼ë¡œ Python íŒŒì¼ ì°¾ê¸°
            for file_path in glob.glob('**/*.py', recursive=True):
                try:
                    file_size = os.path.getsize(file_path)
                    python_files.append(file_path)
                    print(f"  ğŸ“„ {file_path} ({file_size:,} bytes)")
                except OSError:
                    print(f"  âš ï¸  {file_path} (í¬ê¸°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŒ)")
                    python_files.append(file_path)
            
            if not python_files:
                print("  âš ï¸  Python íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                print(f"\nì´ {len(python_files)}ê°œì˜ Python íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
                
        except Exception as e:
            print(f"âŒ íŒŒì¼ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            
        return python_files
    
    def check_git_status(self):
        """í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ Git ìƒíƒœ í™•ì¸"""
        try:
            result = subprocess.run(['git', 'status'], 
                                  capture_output=True, text=True)
            return result.returncode == 0
        except FileNotFoundError:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return False
        except Exception:
            return False
    
    def git_clone(self, repo_url, directory=None):
        """Git ì €ì¥ì†Œ í´ë¡ """
        try:
            print(f"ğŸ“¥ ì €ì¥ì†Œ í´ë¡  ì¤‘: {repo_url}")
            
            if directory:
                result = subprocess.run(['git', 'clone', repo_url, directory], 
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    print(f"âœ“ ì €ì¥ì†Œë¥¼ {directory}ì— í´ë¡ í–ˆìŠµë‹ˆë‹¤.")
                else:
                    print(f"âŒ í´ë¡  ì‹¤íŒ¨: {result.stderr}")
                    return False
            else:
                result = subprocess.run(['git', 'clone', repo_url], 
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    print(f"âœ“ ì €ì¥ì†Œë¥¼ í´ë¡ í–ˆìŠµë‹ˆë‹¤.")
                else:
                    print(f"âŒ í´ë¡  ì‹¤íŒ¨: {result.stderr}")
                    return False
            return True
            
        except FileNotFoundError:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return False
        except Exception as e:
            print(f"âŒ í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return False
    
    def git_pull(self):
        """í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ Git pull ì‹¤í–‰"""
        if not self.check_git_status():
            print("âŒ í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.")
            return False
        
        try:
            # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
            branch_result = subprocess.run(['git', 'branch', '--show-current'], 
                                         capture_output=True, text=True)
            if branch_result.returncode == 0 and branch_result.stdout:
                current_branch = branch_result.stdout.strip()
                print(f"ğŸŒ¿ í˜„ì¬ ë¸Œëœì¹˜: {current_branch}")
            else:
                print("ğŸŒ¿ í˜„ì¬ ë¸Œëœì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            # Git pull ì‹¤í–‰
            print("ğŸ“¥ Git pull ì‹¤í–‰ ì¤‘...")
            pull_result = subprocess.run(['git', 'pull'], 
                                       capture_output=True, text=True)
            
            if pull_result.returncode == 0:
                if pull_result.stdout and "Already up to date" in pull_result.stdout:
                    print("âœ“ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.")
                else:
                    print("âœ“ ì—…ë°ì´íŠ¸ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
                    if pull_result.stdout:
                        print(pull_result.stdout)
            else:
                print(f"âŒ Pull ì‹¤íŒ¨: {pull_result.stderr}")
                return False
                
            return True
            
        except FileNotFoundError:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return False
        except Exception as e:
            print(f"âŒ Pull ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return False
    
    def git_fetch(self):
        """ì›ê²© ì €ì¥ì†Œì˜ ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸° (ë³‘í•©í•˜ì§€ ì•ŠìŒ)"""
        if not self.check_git_status():
            print("âŒ í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.")
            return False
        
        try:
            print("ğŸ“¡ Git fetch ì‹¤í–‰ ì¤‘...")
            result = subprocess.run(['git', 'fetch'], capture_output=True, text=True)
            
            if result.returncode == 0:
                print("âœ“ ì›ê²© ì €ì¥ì†Œì˜ ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
                
                # ë¡œì»¬ê³¼ ì›ê²©ì˜ ì°¨ì´ í™•ì¸
                status_result = subprocess.run(['git', 'status', '-uno'], 
                                             capture_output=True, text=True)
                if status_result.stdout:
                    if "Your branch is behind" in status_result.stdout:
                        print("â„¹ï¸  ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì›ê²© ë¸Œëœì¹˜ë³´ë‹¤ ë’¤ì²˜ì ¸ ìˆìŠµë‹ˆë‹¤.")
                        print("   'git pull'ì„ ì‹¤í–‰í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    elif "Your branch is ahead" in status_result.stdout:
                        print("â„¹ï¸  ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì›ê²© ë¸Œëœì¹˜ë³´ë‹¤ ì•ì„œ ìˆìŠµë‹ˆë‹¤.")
                    else:
                        print("âœ“ ë¡œì»¬ê³¼ ì›ê²©ì´ ë™ê¸°í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            else:
                print(f"âŒ Fetch ì‹¤íŒ¨: {result.stderr}")
                return False
                
            return True
            
        except FileNotFoundError:
            print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return False
        except Exception as e:
            print(f"âŒ Fetch ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return False


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    manager = GitPythonManager()
    
    print("=== Git ë° Python íŒŒì¼ ê´€ë¦¬ ë„êµ¬ ===\n")
    
    # 1. Git ì‚¬ìš©ì ì„¤ì •
    print("1ï¸âƒ£ Git ì‚¬ìš©ì ì„¤ì •")
    manager.setup_git_user()
    
    # 2. Python íŒŒì¼ ëª©ë¡ ì‘ì„±
    print("\n2ï¸âƒ£ Python íŒŒì¼ ëª©ë¡ ì‘ì„±")
    python_files = manager.list_python_files()
    
    # 3. Git ì‘ì—… ì„ íƒ
    print("\n3ï¸âƒ£ Git ì‘ì—…")
    
    if manager.check_git_status():
        print("âœ“ í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” Git ì €ì¥ì†Œì…ë‹ˆë‹¤.")
        print("\nì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:")
        print("1. Git Pull (ë³€ê²½ì‚¬í•­ ë‹¤ìš´ë¡œë“œ ë° ë³‘í•©)")
        print("2. Git Fetch (ë³€ê²½ì‚¬í•­ í™•ì¸ë§Œ)")
        print("3. ìƒˆ ì €ì¥ì†Œ í´ë¡ ")
        print("4. ì¢…ë£Œ")
        
        try:
            choice = input("\nì„ íƒ (1-4): ").strip()
            
            if choice == '1':
                manager.git_pull()
            elif choice == '2':
                manager.git_fetch()
            elif choice == '3':
                repo_url = input("ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
                if repo_url:
                    manager.git_clone(repo_url)
                else:
                    print("âš ï¸  URLì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            elif choice == '4':
                print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            else:
                print("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")
        except KeyboardInterrupt:
            print("\n\ní”„ë¡œê·¸ë¨ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
    else:
        print("âš ï¸  í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.")
        print("\nì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:")
        print("1. ìƒˆ ì €ì¥ì†Œ í´ë¡ ")
        print("2. í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ Git ì €ì¥ì†Œë¡œ ì´ˆê¸°í™”")
        print("3. ì¢…ë£Œ")
        
        try:
            choice = input("\nì„ íƒ (1-3): ").strip()
            
            if choice == '1':
                repo_url = input("ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
                if repo_url:
                    directory = input("í´ë¡ í•  ë””ë ‰í† ë¦¬ ì´ë¦„ (ë¹„ì›Œë‘ë©´ ê¸°ë³¸ê°’): ").strip()
                    manager.git_clone(repo_url, directory if directory else None)
                else:
                    print("âš ï¸  URLì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            elif choice == '2':
                try:
                    result = subprocess.run(['git', 'init'], capture_output=True, text=True)
                    if result.returncode == 0:
                        print("âœ“ Git ì €ì¥ì†Œë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.")
                    else:
                        print(f"âŒ Git ì´ˆê¸°í™” ì‹¤íŒ¨: {result.stderr}")
                except FileNotFoundError:
                    print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
                except Exception as e:
                    print(f"âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            elif choice == '3':
                print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            else:
                print("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")
        except KeyboardInterrupt:
            print("\n\ní”„ë¡œê·¸ë¨ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")


if __name__ == "__main__":
    # Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    try:
        result = subprocess.run(['git', '--version'], capture_output=True, text=True)
        if result.returncode != 0:
            print("âŒ Gitì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            print("   Gitì„ ë‹¤ì‹œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: https://git-scm.com/downloads")
            sys.exit(1)
        else:
            print(f"âœ“ Git ë²„ì „: {result.stdout.strip()}")
    except FileNotFoundError:
        print("âŒ Gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
        print("   Gitì„ ë¨¼ì € ì„¤ì¹˜í•´ì£¼ì„¸ìš”: https://git-scm.com/downloads")
        print("\n   Windows: https://git-scm.com/download/win")
        print("   ì„¤ì¹˜ í›„ VSCodeë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.")
        sys.exit(1)
    
    main()